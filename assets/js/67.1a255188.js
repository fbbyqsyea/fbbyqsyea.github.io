(window.webpackJsonp=window.webpackJsonp||[]).push([[67],{368:function(t,s,a){"use strict";a.r(s);var n=a(5),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"【生产debug日记】go-map-并发操作导致的k8s服务重启"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#【生产debug日记】go-map-并发操作导致的k8s服务重启"}},[t._v("#")]),t._v(" 【生产Debug日记】Go Map 并发操作导致的K8S服务重启")]),t._v(" "),s("h2",{attrs:{id:"背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),s("p",[t._v("最近从"),s("code",[t._v("grafana")]),t._v("的"),s("code",[t._v("alert")]),t._v("中收到一个告警，告警内容是"),s("code",[t._v("K8S")]),t._v("服务"),s("code",[t._v("pod")]),t._v("重启了，查看"),s("code",[t._v("pod")]),t._v("日志描述信息显示如下：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl describe xxxxxx-api-6577f45dd5-9gprq")]),t._v("\nName:         xxxxxx-api-6577f45dd5-9gprq\nNamespace:    xxxxxx\nPriority:     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nNode:         "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".11.15/10.0.11.15\nStart Time:   Tue, "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" Dec "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2024")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":23:07 +0800\nLabels:       pod-template-hash"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("6577f45dd5\n              "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("app")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("xxxxxx-api\nAnnotations:  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nStatus:       Running\nIP:           "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.230")]),t._v(".83.56\nIPs:\n  IP:           "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.230")]),t._v(".83.56\nControlled By:  ReplicaSet/xxxxxx-api-6577f45dd5\nContainers:\n  xxxxxx-api:\n    Container ID:   docker://40ad476607e55cec892f495ac668ad8e30dc6e3f8c4e80a50c00ddc926f5e918\n    Image:          harbor.k8s.com/fanli_xxxxxx/xxxxxx_api:v0.0.0-20241224161914\n    Image ID:       docker-pullable://harbor.k8s.com/xxxxxx/xxxxxx_api@sha256:b04d274d0c448ed1159d1ea341fcd8ec3480016c260ac7b151eea607d0da9458\n    Port:           "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8888")]),t._v("/TCP\n    Host Port:      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/TCP\n    State:          Running\n      Started:      Wed, "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v(" Dec "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2024")]),t._v(" 08:44:18 +0800\n    Last State:     Terminated\n      Reason:       Error\n      xxxxxx Code:    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n      Started:      Wed, "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v(" Dec "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2024")]),t._v(" 05:12:12 +0800\n      Finished:     Wed, "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v(" Dec "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2024")]),t._v(" 08:44:16 +0800\n    Ready:          True\n    Restart Count:  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("\n    Limits:\n      cpu:  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("\n    Requests:\n      cpu:      500m\n      memory:   1048Mi\n    Liveness:   http-get http://:8888/healthcheck "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("delay")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("5s "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("timeout")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("3s "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("period")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("45s "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#success=1 #failure=3")]),t._v("\n    Readiness:  http-get http://:8888/healthcheck "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("delay")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("5s "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("timeout")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("1s "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("period")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("10s "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#success=3 #failure=3")]),t._v("\n    Environment:\n      MY_POD_NAME:  xxxxxx-api-6577f45dd5-9gprq "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v1:metadata.name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    Mounts:\n      /data/applogs from xxxxxxwebdata-log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rw"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      /data/weblogs from xxxxxxwebdata-log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rw"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-zd7z8 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ro"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nConditions:\n  Type              Status\n  Initialized       True \n  Ready             True \n  ContainersReady   True \n  PodScheduled      True \nVolumes:\n  xxxxxxwebdata-log:\n    Type:          HostPath "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bare "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" directory volume"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    Path:          /xxxxxx/logs/\n    HostPathType:  DirectoryOrCreate\n  default-token-zd7z8:\n    Type:        Secret "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a volume populated by a Secret"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    SecretName:  default-token-zd7z8\n    Optional:    "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\nQoS Class:       Burstable\nNode-Selectors:  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Physical-machine\nTolerations:     node.kubernetes.io/not-ready:NoExecute "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("op")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Exists "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" 300s\n                 node.kubernetes.io/unreachable:NoExecute "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("op")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Exists "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" 300s\nEvents:          "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),s("p",[t._v("可以从描述信息中看出，Pod在运行时重启了4次，并且最后一次重启是因为xxxxxx Code为2，表示程序异常退出。我们继续查看Pod的日志，以获取更多详细信息。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl logs xxxxxx-api-6577f45dd5-9gprq --previous")]),t._v("\n")])])]),s("p",[t._v("输入日志很多，主要的报错信息如下：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("fatal error: concurrent map iteration and map "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),t._v("\n\ngoroutine "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("162439")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("running"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":\ngithub.com/dtapps/go-library/utils/gorequest."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("*Params"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".DeepCopy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t/go/pkg/mod/github.com/dtapps/go-library@v1.0.157/utils/gorequest/params.go:66\ngithub.com/dtapps/go-library/utils/gorequest.request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0xc0004204e0, "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("0x3111ee0, 0x481d920"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t/go/pkg/mod/github.com/dtapps/go-library@v1.0.157/utils/gorequest/http.go:195 +0x19a\ngithub.com/dtapps/go-library/utils/gorequest."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("*App"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".Get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0xc000562710?, "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("0x3111ee0?, 0x481d920?"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(", "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("0x0?, 0xc0005627a0?, 0x411c5b?"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t/go/pkg/mod/github.com/dtapps/go-library@v1.0.157/utils/gorequest/http.go:170 +0xd8\ngithub.com/dtapps/go-library/service/pinduoduo."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("*Client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0xc0004369c0, "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("0x3111ee0, 0x481d920"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(", 0xc0010c0d80"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t/go/pkg/mod/github.com/dtapps/go-library@v1.0.157/service/pinduoduo/request.go:21 +0x197\ngithub.com/dtapps/go-library/service/pinduoduo."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("*Client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".GoodsDetail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0xc0004369c0, "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("0x3111ee0, 0x481d920"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(", "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("0xc000562d90?, 0x1?, 0x1?"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t/go/pkg/mod/github.com/dtapps/go-library@v1.0.157/service/pinduoduo/pdd.ddk.goods.detail.go:106 +0x11c\ngitea.xxxxxx.com/goweb/fsdk-go/fsdkunion."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("*PddClient"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".PddDdkGoodsDetail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0xc000211620?, 0x0, "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("0xc0014bd1d0, 0x24"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(", 0xc0010c0d50"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t/go/pkg/mod/gitea.xxxxxx.com/goweb/fsdk-go@v0.0.0-20241221060227-0ed7d0a9c9ac/fsdkunion/pdd.go:69 +0x96\ngitea.xxxxxx.com/goweb/xxxxxx/api/internal/service."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("*Service"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".GetUnionPddItemDetail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0xc000783500, 0xc0010c0d50?, "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("0xc0014bd1d0?, 0xa?"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(", 0xc000514120?"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t/builder/api/internal/service/unionpddservice.go:143 +0x8b\ngitea.xxxxxx.com/goweb/xxxxxx/api/internal/service."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("*Service"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".GetUnionPddItemsByGoodsSignList.func1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("0xc0011eb1a0?, 0xc0016c68c0?, 0xc00061b7a0?"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t/builder/api/internal/service/unionpddservice.go:96 +0x179\ngitea.xxxxxx.com/goweb/fsdk-go/fsdktype."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("*SafeGo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".Go.func1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("0x0?, 0x72aea5?, 0xc000ef5d40?"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t/go/pkg/mod/gitea.xxxxxx.com/goweb/fsdk-go@v0.0.0-20241221060227-0ed7d0a9c9ac/fsdktype/safego.go:36 +0x96\ncreated by gitea.xxxxxx.com/goweb/fsdk-go/fsdktype."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("*SafeGo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".Go "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" goroutine "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("162413")]),t._v("\n\t/go/pkg/mod/gitea.xxxxxx.com/goweb/fsdk-go@v0.0.0-20241221060227-0ed7d0a9c9ac/fsdktype/safego.go:24 +0xe7\n")])])]),s("p",[t._v("从上面的日志可以看出，服务退出的原因是："),s("code",[t._v("map")]),t._v("发生了并发的遍历和修改。发生在"),s("code",[t._v("github.com/dtapps/go-library/utils/gorequest.(*Params).DeepCopy")]),t._v("函数中。函数内容如下：")]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// DeepCopy 深度复制")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Params"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("DeepCopy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\ttargetMap "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 从原始复制到目标")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("p "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\ttargetMap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" value\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重新申请一个新的map")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("p "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" targetMap\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("从代码中可以看出，"),s("code",[t._v("DeepCopy")]),t._v("函数的主要功能是将"),s("code",[t._v("Params")]),t._v("类型的值复制到一个新的"),s("code",[t._v("map")]),t._v("中，并清空原始的"),s("code",[t._v("map")]),t._v("。这里发送并发读写的只能是"),s("code",[t._v("*p")]),t._v("。我们接着往上找"),s("code",[t._v("Prams")]),t._v("类型的定义和引用。")]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Params 参数")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Params "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// App 实例")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" App "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tUri                          "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("           "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 全局请求地址，没有设置url才会使用")]),t._v("\n\tError                        "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v("            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 错误")]),t._v("\n\thttpUri                      "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("           "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求地址")]),t._v("\n\thttpMethod                   "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("           "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求方法")]),t._v("\n\thttpHeader                   Headers          "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求头")]),t._v("\n\thttpParams                   Params           "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求参数")]),t._v("\n\thttpCookie                   "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("           "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Cookie")]),t._v("\n\tresponseContent              Response         "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回内容")]),t._v("\n\thttpContentType              "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("           "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求内容类型")]),t._v("\n\tdebug                        "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("             "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 是否开启调试模式")]),t._v("\n\tp12Cert                      "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("tls"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Certificate "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// p12证书内容")]),t._v("\n\ttlsMinVersion"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tlsMaxVersion "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint16")]),t._v("           "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// TLS版本")]),t._v("\n\tconfig                       "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tsystemOs     "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 系统类型")]),t._v("\n\t\tsystemKernel "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 系统内核")]),t._v("\n\t\tgoVersion    "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// go版本")]),t._v("\n\t\tsdkVersion   "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// sdk版本")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("到这里我们可以看出，"),s("code",[t._v("Params")]),t._v("类型是"),s("code",[t._v("App")]),t._v("结构体中的一个字段。"),s("code",[t._v("App")]),t._v("结构体在"),s("code",[t._v("github.com/dtapps/go-library/utils/gorequest")]),t._v("包中定义。我们接着往上找"),s("code",[t._v("App")]),t._v("类型的定义和引用。")]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Client 实例")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Client "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\trequestClient "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("gorequest"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("App "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求服务")]),t._v("\n\tconfig        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tclientId     "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// POP分配给应用的client_id")]),t._v("\n\t\tclientSecret "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// POP分配给应用的client_secret")]),t._v("\n\t\tmediaId      "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 媒体ID")]),t._v("\n\t\tpid          "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 推广位")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tzap "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tstatus "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("             "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 状态")]),t._v("\n\t\tclient "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("golog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ApiZapLog "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 日志服务")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("从代码中可以看出，"),s("code",[t._v("App")]),t._v("类型是"),s("code",[t._v("Client")]),t._v("结构体中的一个字段。"),s("code",[t._v("Client")]),t._v("类型在"),s("code",[t._v("github.com/dtapps/go-library/service/pinduoduo")]),t._v("包中定义。我们接着往上找"),s("code",[t._v("Client")]),t._v("类型的定义和引用。")]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拼多多客户端")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" PddClient "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tAppKey    "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\tAppSecret "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\tMediaId   "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\tPid       "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\tclient    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("pinduoduo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Client\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("到这里事情就明了了，我们在服务中定义拼多多客户端的时候只实例了一个"),s("code",[t._v("pinduoduo.Client")]),t._v("，当又多个请求同时调用"),s("code",[t._v("GetUnionPddItemDetail")]),t._v("方法时，就会发生并发读写"),s("code",[t._v("Params")]),t._v("类型的值，导致程序崩溃。")]),t._v(" "),s("h3",{attrs:{id:"解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),s("p",[t._v("在我们自己定义的"),s("code",[t._v("PddClient")]),t._v("中，我们只记录拼多多的"),s("code",[t._v("AppKey")]),t._v("、"),s("code",[t._v("AppSecret")]),t._v("、"),s("code",[t._v("MediaId")]),t._v("和"),s("code",[t._v("Pid")]),t._v("，而不记录"),s("code",[t._v("pinduoduo.Client")]),t._v("。在每次请求时，我们重新实例化"),s("code",[t._v("pinduoduo.Client")]),t._v("，这样就不会发生并发读写"),s("code",[t._v("Params")]),t._v("类型的值了。")]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拼多多客户端")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" PddClient "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tAppKey    "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\tAppSecret "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\tMediaId   "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\tPid       "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Client 实例")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("PddClient"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Client")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("pinduoduo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Client "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" pinduoduo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewClient")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AppKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AppSecret"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MediaId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Pid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);