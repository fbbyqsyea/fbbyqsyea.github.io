<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>【生产Debug日记】微信IP白名单配置导致接口调用失败 | bing随遇而安</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="
背景介绍
公司的一个公众号内嵌H5页面，用户在公众号内打开这个H5页面，点击页面的按钮打开微信小程序来领取优惠券。

运营反馈从昨天开始，用户点击打开小程序的按钮后没有反应，但是点击跳转h5的按钮可以正常跳转。而且时好时坏，并不是每次点击都无效。由于影响范围较大（公众号的主要功能受影响，受影响活跃用户在5w左右），所以进行了立即排查。

页面结构
H5的页面内部的主要逻辑是展示优惠 ...">
    
    <link rel="preload" href="/assets/css/0.styles.29350883.css" as="style"><link rel="preload" href="/assets/js/app.4c7f9b01.js" as="script"><link rel="preload" href="/assets/js/6.38d57c41.js" as="script"><link rel="preload" href="/assets/js/3.122d5fd9.js" as="script"><link rel="preload" href="/assets/js/64.a5e4a955.js" as="script"><link rel="prefetch" href="/assets/js/10.0d31e31c.js"><link rel="prefetch" href="/assets/js/11.2657ec05.js"><link rel="prefetch" href="/assets/js/12.d23da198.js"><link rel="prefetch" href="/assets/js/13.cb896045.js"><link rel="prefetch" href="/assets/js/14.f7014cd5.js"><link rel="prefetch" href="/assets/js/15.b4fdfaf9.js"><link rel="prefetch" href="/assets/js/16.cc195c77.js"><link rel="prefetch" href="/assets/js/17.87670a9c.js"><link rel="prefetch" href="/assets/js/18.befdd24e.js"><link rel="prefetch" href="/assets/js/19.c871bc56.js"><link rel="prefetch" href="/assets/js/20.3cc1bb01.js"><link rel="prefetch" href="/assets/js/21.a51c24b2.js"><link rel="prefetch" href="/assets/js/22.41e12695.js"><link rel="prefetch" href="/assets/js/23.8f39c275.js"><link rel="prefetch" href="/assets/js/24.f4628365.js"><link rel="prefetch" href="/assets/js/25.80262333.js"><link rel="prefetch" href="/assets/js/26.42170d67.js"><link rel="prefetch" href="/assets/js/27.0fbc85df.js"><link rel="prefetch" href="/assets/js/28.6b97c924.js"><link rel="prefetch" href="/assets/js/29.5e8124a6.js"><link rel="prefetch" href="/assets/js/30.02255af3.js"><link rel="prefetch" href="/assets/js/31.4eb2a645.js"><link rel="prefetch" href="/assets/js/32.df0d2cc3.js"><link rel="prefetch" href="/assets/js/33.6fb72d23.js"><link rel="prefetch" href="/assets/js/34.77ca4544.js"><link rel="prefetch" href="/assets/js/35.c8d6f4fa.js"><link rel="prefetch" href="/assets/js/36.02d94fa8.js"><link rel="prefetch" href="/assets/js/37.9b94c454.js"><link rel="prefetch" href="/assets/js/38.e4061449.js"><link rel="prefetch" href="/assets/js/39.b6262564.js"><link rel="prefetch" href="/assets/js/4.380f1af6.js"><link rel="prefetch" href="/assets/js/40.87d1a9f9.js"><link rel="prefetch" href="/assets/js/41.4be424ee.js"><link rel="prefetch" href="/assets/js/42.7ef114b4.js"><link rel="prefetch" href="/assets/js/43.d18752d5.js"><link rel="prefetch" href="/assets/js/44.1cdde598.js"><link rel="prefetch" href="/assets/js/45.9fc18aa9.js"><link rel="prefetch" href="/assets/js/46.9f1a2e78.js"><link rel="prefetch" href="/assets/js/47.0f2e95bf.js"><link rel="prefetch" href="/assets/js/48.99e44d88.js"><link rel="prefetch" href="/assets/js/49.53b707c6.js"><link rel="prefetch" href="/assets/js/5.084c9b71.js"><link rel="prefetch" href="/assets/js/50.cf6f1a0e.js"><link rel="prefetch" href="/assets/js/51.edc8ea0b.js"><link rel="prefetch" href="/assets/js/52.c4c9cc09.js"><link rel="prefetch" href="/assets/js/53.1c990a56.js"><link rel="prefetch" href="/assets/js/54.4be07845.js"><link rel="prefetch" href="/assets/js/55.6377835e.js"><link rel="prefetch" href="/assets/js/56.96fefd29.js"><link rel="prefetch" href="/assets/js/57.ac62e0fb.js"><link rel="prefetch" href="/assets/js/58.e72496b2.js"><link rel="prefetch" href="/assets/js/59.0e60a760.js"><link rel="prefetch" href="/assets/js/60.6556fe09.js"><link rel="prefetch" href="/assets/js/61.9592565f.js"><link rel="prefetch" href="/assets/js/62.a02c6162.js"><link rel="prefetch" href="/assets/js/63.739ae802.js"><link rel="prefetch" href="/assets/js/65.9324b47f.js"><link rel="prefetch" href="/assets/js/66.dee90438.js"><link rel="prefetch" href="/assets/js/67.68103628.js"><link rel="prefetch" href="/assets/js/68.4b85d060.js"><link rel="prefetch" href="/assets/js/69.3de2ffca.js"><link rel="prefetch" href="/assets/js/7.358fd391.js"><link rel="prefetch" href="/assets/js/70.27460e12.js"><link rel="prefetch" href="/assets/js/71.78f4b2ff.js"><link rel="prefetch" href="/assets/js/72.e6c0936f.js"><link rel="prefetch" href="/assets/js/73.9c8ac753.js"><link rel="prefetch" href="/assets/js/74.44da800e.js"><link rel="prefetch" href="/assets/js/75.a7aac338.js"><link rel="prefetch" href="/assets/js/76.dff0ed07.js"><link rel="prefetch" href="/assets/js/77.f2bc039f.js"><link rel="prefetch" href="/assets/js/78.c9f83bbc.js"><link rel="prefetch" href="/assets/js/79.1679c421.js"><link rel="prefetch" href="/assets/js/8.d351dd84.js"><link rel="prefetch" href="/assets/js/80.f12cb5ae.js"><link rel="prefetch" href="/assets/js/81.52dc49de.js"><link rel="prefetch" href="/assets/js/82.137da228.js"><link rel="prefetch" href="/assets/js/83.ccbc9c10.js"><link rel="prefetch" href="/assets/js/84.7f4d9f0f.js"><link rel="prefetch" href="/assets/js/85.f2744328.js"><link rel="prefetch" href="/assets/js/86.60261027.js"><link rel="prefetch" href="/assets/js/87.5f0c199f.js"><link rel="prefetch" href="/assets/js/88.512babd8.js"><link rel="prefetch" href="/assets/js/89.2588dc74.js"><link rel="prefetch" href="/assets/js/9.0a60c476.js"><link rel="prefetch" href="/assets/js/90.267b25d4.js"><link rel="prefetch" href="/assets/js/91.aec3a3c8.js"><link rel="prefetch" href="/assets/js/92.034425bc.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.ac365ac7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.29350883.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">bing随遇而安 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">首页</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">bing随遇而安 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">首页</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">BING随遇而安</span> <span itemprop="address">   in Shanghai</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2024-11-26T00:00:00.000Z">
      2024-11-26
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/weixin" data-v-42ccfcd5><span data-v-42ccfcd5>weixin</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/【生产Debug日记】" data-v-42ccfcd5><span data-v-42ccfcd5>【生产Debug日记】</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h1 id="【生产debug日记】微信ip白名单配置导致接口调用失败"><a href="#【生产debug日记】微信ip白名单配置导致接口调用失败" class="header-anchor">#</a> 【生产Debug日记】微信IP白名单配置导致接口调用失败</h1> <h2 id="背景介绍"><a href="#背景介绍" class="header-anchor">#</a> 背景介绍</h2> <p>公司的一个公众号内嵌H5页面，用户在公众号内打开这个H5页面，点击页面的按钮打开微信小程序来领取优惠券。</p> <p>运营反馈从昨天开始，用户点击打开小程序的按钮后没有反应，但是点击跳转h5的按钮可以正常跳转。而且时好时坏，并不是每次点击都无效。由于影响范围较大（公众号的主要功能受影响，受影响活跃用户在5w左右），所以进行了立即排查。</p> <h2 id="页面结构"><a href="#页面结构" class="header-anchor">#</a> 页面结构</h2> <p>H5的页面内部的主要逻辑是展示优惠券领取按钮（包括小程序和H5）。页面从点击到加载完成主要进行了下面的操作。</p> <ul><li>静默授权获取用户的<code>openid</code></li> <li>生成优惠券跳转的<code>path</code>和链接。</li> <li>生成微信JSSDK的配置参数，包括<code>appId</code>、<code>timestamp</code>、<code>nonceStr</code>和<code>signature</code>，用于调用微信JSSDK的接口。</li> <li>后端渲染页面优惠券部分，其中使用了<code>wx-open-launch-weapp</code>标签来打开小程序。</li> <li>通过<code>wx.config</code>接口注入权限验证配置。</li></ul> <h2 id="初步分析"><a href="#初步分析" class="header-anchor">#</a> 初步分析</h2> <p>由于这个业务稳定运行了三年多了，最近没有迭代，所以初步分析不应该是代码层面的问题。所以排查的方向主要集中在动态生成的信息上面。主要排查了以下几个方向。</p> <h3 id="小程序path是否生成"><a href="#小程序path是否生成" class="header-anchor">#</a> 小程序<code>path</code>是否生成</h3> <p>H5页面通过<code>wx-open-launch-weapp</code>标签来打开小程序，需要<code>username</code>和<code>path</code>两个参数。<code>username</code>是固定的，所以排查的方向是<code>path</code>是否生成。通过日志和前端调试发现，<code>path</code>是正常生成的。所以初步判断<code>path</code>生成没有问题。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>wx-open-launch-weapp</span> <span class="token attr-name">username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gh_xxxxx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/index/pages/xxxxxx<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 6.41rem<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/wxtag-template<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"><span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">&quot;position: absolute; width: 100%; height: 100%;&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>wx-open-launch-weapp</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="微信jssdk配置是否生成并注入成功"><a href="#微信jssdk配置是否生成并注入成功" class="header-anchor">#</a> 微信JSSDK配置是否生成并注入成功</h3> <p>微信JS-SDK是微信公众平台 面向网页开发者提供的基于微信内的网页开发工具包。</p> <p>通过使用微信JS-SDK，网页开发者可借助微信高效地使用拍照、选图、语音、位置等手机系统的能力，同时可以直接使用微信分享、扫一扫、卡券、支付等微信特有的能力，为微信用户提供更优质的网页体验。</p> <p>微信JSSDK的配置参数包括<code>appId</code>、<code>timestamp</code>、<code>nonceStr</code>和<code>signature</code>，这些参数都是通过后端生成并注入到页面中的。通过后端日志查看参数生成成功，但是查询前端<code>console</code>日志发现<code>wx.config</code>接口没有调用成功，一致报 <code>config:fail,invalid signature</code>，所以初步判断微信JSSDK配置没有注入成功。</p> <div class="language-js extra-class"><pre class="language-js"><code>  wx<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">debug</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span>
    <span class="token literal-property property">appId</span><span class="token operator">:</span> <span class="token string">'xxxxxx'</span><span class="token punctuation">,</span> <span class="token comment">// 必填，公众号的唯一标识</span>
    <span class="token literal-property property">timestamp</span><span class="token operator">:</span> <span class="token number">1732606316</span><span class="token punctuation">,</span> <span class="token comment">// 必填，生成签名的时间戳</span>
    <span class="token literal-property property">nonceStr</span><span class="token operator">:</span> <span class="token string">'xxxxxxx'</span><span class="token punctuation">,</span> <span class="token comment">// 必填，生成签名的随机串</span>
    <span class="token literal-property property">signature</span><span class="token operator">:</span> <span class="token string">'xxxxxxxx'</span><span class="token punctuation">,</span><span class="token comment">// 必填，签名</span>
    <span class="token literal-property property">jsApiList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'getLocation'</span><span class="token punctuation">,</span> <span class="token string">'openLocation'</span><span class="token punctuation">,</span> <span class="token string">'updateAppMessageShareData'</span><span class="token punctuation">,</span> <span class="token string">'updateTimelineShareData'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 必填，需要使用的JS接口列表</span>
    <span class="token literal-property property">openTagList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'wx-open-launch-weapp'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="深入排查"><a href="#深入排查" class="header-anchor">#</a> 深入排查</h2> <p>到这一步，我们已经初步定位到问题是微信JSSDK配置签名失败，但是具体原因还需要进一步排查。由于微信JSSDK的配置参数是通过后端生成并注入到页面中的，所以排查的方向是后端生成签名的过程。由于生产环境受影响较大，所以直接在生产灰度机上进行调试。</p> <p>微信的JSSDK签名算法如下：</p> <ol><li>参考以下文档获取access_token（有效期7200秒，开发者必须在自己的服务全局缓存access_token）：https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html</li> <li>用第一步拿到的access_token 采用http GET方式请求获得jsapi_ticket（有效期7200秒，开发者必须在自己的服务全局缓存jsapi_ticket）：https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&amp;type=jsapi</li></ol> <p>成功返回如下JSON：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;errcode&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;errmsg&quot;</span><span class="token operator">:</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ticket&quot;</span><span class="token operator">:</span><span class="token string">&quot;bxLdikRXVbTPdHSM05e5u5sUoXNKd8-41ZO3MhKoyN5OfkWITDGgnr2fwJ0m9E8NYzWKVZvdVtaUgWvsdshFKA&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span><span class="token number">7200</span>
<span class="token punctuation">}</span>
</code></pre></div><p>获得jsapi_ticket之后，就可以生成JS-SDK权限验证的签名了。</p> <ol start="3"><li>签名算法如下：参与签名的字段包括noncestr（随机字符串）, 有效的jsapi_ticket, timestamp（时间戳）, url（当前网页的URL，不包含#及其后面部分） 。对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，使用URL键值对的格式（即key1=value1&amp;key2=value2…）拼接成字符串string1。这里需要注意的是所有参数名均为小写字符。对string1作sha1加密，字段名和字段值都采用原始值，不进行URL 转义。</li></ol> <p>示例：</p> <div class="language-js extra-class"><pre class="language-js"><code>noncestr<span class="token operator">=</span>Wm3WZYTPz0wzccnW
jsapi_ticket<span class="token operator">=</span>sM4AOVdWfPE4DxkXGEs8VMCPGGVi4C3VM0P37wVUCFvkVAy_90u5h9nbSlYy3<span class="token operator">-</span>Sl<span class="token operator">-</span>HhTdfl2fzFy1AOcHKP7qg
timestamp<span class="token operator">=</span><span class="token number">1414587457</span>
url<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mp<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token operator">?</span>params<span class="token operator">=</span>value
</code></pre></div><p>步骤1. 对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，使用URL键值对的格式（即key1=value1&amp;key2=value2…）拼接成字符串string1：</p> <div class="language-js extra-class"><pre class="language-js"><code>jsapi_ticket<span class="token operator">=</span>sM4AOVdWfPE4DxkXGEs8VMCPGGVi4C3VM0P37wVUCFvkVAy_90u5h9nbSlYy3<span class="token operator">-</span>Sl<span class="token operator">-</span>HhTdfl2fzFy1AOcHKP7qg<span class="token operator">&amp;</span>noncestr<span class="token operator">=</span>Wm3WZYTPz0wzccnW<span class="token operator">&amp;</span>timestamp<span class="token operator">=</span><span class="token number">1414587457</span><span class="token operator">&amp;</span>url<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mp<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token operator">?</span>params<span class="token operator">=</span>value
</code></pre></div><p>步骤2. 对string1进行sha1签名，得到signature：</p> <div class="language-js extra-class"><pre class="language-js"><code>0f9de62fce790f9a083d5c99e95740ceb90c27ed
</code></pre></div><p>如果签名失败，所以首先怀疑<code>ticket</code>是否生成成功，代码中的<code>ticket</code>是被动缓存的，因此查询对应的<code>redis key</code>。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ get weixin:xxxxx:ticket
</code></pre></div><p>发现<code>ticket</code>不存在，因此可以确定<code>ticket</code>生成失败，进一步排查发现<code>access_token</code>生成失败。</p> <p>生成<code>ticket</code>和<code>token</code>的代码如下：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * 获取ticket
 *
 * @return string
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$ticket</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$cacheKey</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;weixin:xxxxx:ticket&quot;</span><span class="token punctuation">;</span>
    <span class="token variable">$ticket</span> <span class="token operator">=</span> <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$cacheKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$ticket</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">URL_JSAPI_TICKET</span><span class="token punctuation">,</span> <span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$return</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$return</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ticket'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$ticket</span> <span class="token operator">=</span> <span class="token variable">$return</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ticket'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">setex</span><span class="token punctuation">(</span><span class="token variable">$cacheKey</span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token variable">$ticket</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$ticket</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * 获取token
 *
 * @return string
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$cacheKey</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;weixin:xxxxx_appid:xxxxxx_secret:token&quot;</span><span class="token punctuation">;</span>
     <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$cacheKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">URL_ACCESS_TOKEN</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_appId</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_appSecrectKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$return</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$return</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'access_token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$return</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'access_token'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">setex</span><span class="token punctuation">(</span><span class="token variable">$cacheKey</span><span class="token punctuation">,</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$return</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'expires_in'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$token</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用生成token的接口返回：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;errcode&quot;</span><span class="token operator">:</span> <span class="token number">40164</span><span class="token punctuation">,</span>
    <span class="token property">&quot;errmsg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;invalid ip xxx.xxx.xxx.xxx ipv6 ::fxxx.xxx.xxx.xxx, not in whitelist rid: xxxxxxxx&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到这里可以确定，<code>access_token</code>生成失败的原因是<code>ip</code>不在白名单中，因此需要将<code>ip</code>添加到白名单中。</p> <h2 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h2> <p>在微信公众号管理后台，将<code>ip</code>添加到白名单中。然后测试发现<code>access_token</code>生成成功，<code>ticket</code>生成成功，<code>jsapi_ticket</code>生成成功，<code>signature</code>生成成功，点击跳转小程序功能正常。</p> <h2 id="问题总结"><a href="#问题总结" class="header-anchor">#</a> 问题总结</h2> <p>在解决完问题之后，我不由在想<code>ip</code>不在白名单里面的问题时有发生，我们应该如何避免呢？<code>ticket</code>和<code>token</code>的代码为什么对调用失败的情况没有任何处理？我们正常应该怎么处理？下面是我的思考：</p> <ol><li>虽然现在在去中台化，但是对于外部的调用，应该还是有中台的概念。建立中台服务。由中台负责和外部服务打交道。公司各个业务部门只需要调用中台服务即可。中台服务负责缓存，错误处理，异常处理等。这样就可以避免很多问题。</li></ol> <ul><li>中台可以固定几个<code>IP</code>地址，方便对外添加固定的IP白名单。</li> <li>中台也可以统计调用量，方便监控和报警。</li></ul> <ol start="2"><li><code>ticket</code>和<code>token</code>的代码对调用失败的情况没有任何处理，这暴露了我们在编写代码时的线性思维和对错误处理的不够重视性，成熟的编程模型通常将日志分为错误日志、警告日志、信息日志、调试日志等是有道理的。我们不能在编程中只考虑正常情况，而忽略了异常情况。我们应该在编写代码时，考虑到各种异常情况，并做好相应的处理。像上面的<code>ticket</code>和<code>token</code>的代码，应该对调用失败的情况进行处理，调用错误处理服务。进行相应级别的处理。</li></ol> <ul><li><code>error</code>级别的错误应该立即通过钉钉或者手机短信进行报警，并通知相关人员。</li> <li><code>warning</code>级别的错误应该记录日志并发送邮件，并通知相关人员。</li> <li><code>info</code>级别的错误应该通过日志进行记录，并定期进行统计和分析。</li> <li><code>debug</code>级别的错误应该通过日志进行记录，并定期进行统计和分析。</li></ul></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#背景介绍" title="背景介绍">背景介绍</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#页面结构" title="页面结构">页面结构</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#初步分析" title="初步分析">初步分析</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#小程序path是否生成" title="小程序path是否生成">小程序path是否生成</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#微信jssdk配置是否生成并注入成功" title="微信JSSDK配置是否生成并注入成功">微信JSSDK配置是否生成并注入成功</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#深入排查" title="深入排查">深入排查</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#解决方案" title="解决方案">解决方案</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#问题总结" title="问题总结">问题总结</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/fbbyqsyea" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8>MIT Licensed | Copyright © 2024-fbbyqsyea</li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4c7f9b01.js" defer></script><script src="/assets/js/6.38d57c41.js" defer></script><script src="/assets/js/3.122d5fd9.js" defer></script><script src="/assets/js/64.a5e4a955.js" defer></script>
  </body>
</html>
