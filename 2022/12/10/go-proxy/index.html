<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>内网goproxy服务搭建配置 | bing随遇而安</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="
goproxy是什么
goproxy是go模块代理服务，主要用来加速获取go模块。官方默认的proxy为:https://proxy.golang.org, 国内主要使用的proxy是由七牛云提供的https://goproxy.cn/。

为什么要在内网搭建goproxy服务 ...">
    
    <link rel="preload" href="/assets/css/0.styles.29350883.css" as="style"><link rel="preload" href="/assets/js/app.a96450f7.js" as="script"><link rel="preload" href="/assets/js/6.38d57c41.js" as="script"><link rel="preload" href="/assets/js/3.122d5fd9.js" as="script"><link rel="preload" href="/assets/js/31.619710f3.js" as="script"><link rel="prefetch" href="/assets/js/10.27343206.js"><link rel="prefetch" href="/assets/js/11.2657ec05.js"><link rel="prefetch" href="/assets/js/12.d23da198.js"><link rel="prefetch" href="/assets/js/13.cb896045.js"><link rel="prefetch" href="/assets/js/14.f7014cd5.js"><link rel="prefetch" href="/assets/js/15.96e62451.js"><link rel="prefetch" href="/assets/js/16.cd507b31.js"><link rel="prefetch" href="/assets/js/17.04f2ae02.js"><link rel="prefetch" href="/assets/js/18.fdec87a3.js"><link rel="prefetch" href="/assets/js/19.c871bc56.js"><link rel="prefetch" href="/assets/js/20.3cc1bb01.js"><link rel="prefetch" href="/assets/js/21.b9d53585.js"><link rel="prefetch" href="/assets/js/22.fb44072f.js"><link rel="prefetch" href="/assets/js/23.050dc1d5.js"><link rel="prefetch" href="/assets/js/24.e780ac86.js"><link rel="prefetch" href="/assets/js/25.80262333.js"><link rel="prefetch" href="/assets/js/26.cea7e97b.js"><link rel="prefetch" href="/assets/js/27.23141d4c.js"><link rel="prefetch" href="/assets/js/28.6e00a82c.js"><link rel="prefetch" href="/assets/js/29.765137d8.js"><link rel="prefetch" href="/assets/js/30.1dfae280.js"><link rel="prefetch" href="/assets/js/32.b2ba2b4e.js"><link rel="prefetch" href="/assets/js/33.8f979719.js"><link rel="prefetch" href="/assets/js/34.77ca4544.js"><link rel="prefetch" href="/assets/js/35.8b63bb58.js"><link rel="prefetch" href="/assets/js/36.b0bfa1bd.js"><link rel="prefetch" href="/assets/js/37.9b94c454.js"><link rel="prefetch" href="/assets/js/38.e4061449.js"><link rel="prefetch" href="/assets/js/39.d954ad62.js"><link rel="prefetch" href="/assets/js/4.380f1af6.js"><link rel="prefetch" href="/assets/js/40.e6e0cf43.js"><link rel="prefetch" href="/assets/js/41.9c6c775f.js"><link rel="prefetch" href="/assets/js/42.77b86103.js"><link rel="prefetch" href="/assets/js/43.33631ddf.js"><link rel="prefetch" href="/assets/js/44.f44794e6.js"><link rel="prefetch" href="/assets/js/45.6d68edbe.js"><link rel="prefetch" href="/assets/js/46.11933b89.js"><link rel="prefetch" href="/assets/js/47.b6e39b73.js"><link rel="prefetch" href="/assets/js/48.0a94ac53.js"><link rel="prefetch" href="/assets/js/49.99856a36.js"><link rel="prefetch" href="/assets/js/5.084c9b71.js"><link rel="prefetch" href="/assets/js/50.cf6f1a0e.js"><link rel="prefetch" href="/assets/js/51.24a5af86.js"><link rel="prefetch" href="/assets/js/52.2c49e28e.js"><link rel="prefetch" href="/assets/js/53.80758316.js"><link rel="prefetch" href="/assets/js/54.576aac00.js"><link rel="prefetch" href="/assets/js/55.a76ea924.js"><link rel="prefetch" href="/assets/js/56.108df189.js"><link rel="prefetch" href="/assets/js/57.1c7288b2.js"><link rel="prefetch" href="/assets/js/58.e72496b2.js"><link rel="prefetch" href="/assets/js/59.0e60a760.js"><link rel="prefetch" href="/assets/js/60.f82dec03.js"><link rel="prefetch" href="/assets/js/61.d786dbab.js"><link rel="prefetch" href="/assets/js/62.65521ed5.js"><link rel="prefetch" href="/assets/js/63.e999e220.js"><link rel="prefetch" href="/assets/js/64.76caf964.js"><link rel="prefetch" href="/assets/js/65.245670f2.js"><link rel="prefetch" href="/assets/js/66.2c9756d2.js"><link rel="prefetch" href="/assets/js/67.cb8dbc1a.js"><link rel="prefetch" href="/assets/js/68.4b85d060.js"><link rel="prefetch" href="/assets/js/69.cc0b7455.js"><link rel="prefetch" href="/assets/js/7.358fd391.js"><link rel="prefetch" href="/assets/js/70.27460e12.js"><link rel="prefetch" href="/assets/js/71.69776f25.js"><link rel="prefetch" href="/assets/js/72.9d92b312.js"><link rel="prefetch" href="/assets/js/73.d6373d32.js"><link rel="prefetch" href="/assets/js/74.49213d4c.js"><link rel="prefetch" href="/assets/js/75.485fa9ac.js"><link rel="prefetch" href="/assets/js/76.bf50bd44.js"><link rel="prefetch" href="/assets/js/77.560cd81c.js"><link rel="prefetch" href="/assets/js/78.616ff34c.js"><link rel="prefetch" href="/assets/js/79.b6a5f07c.js"><link rel="prefetch" href="/assets/js/8.d351dd84.js"><link rel="prefetch" href="/assets/js/80.825b302a.js"><link rel="prefetch" href="/assets/js/81.9b5a9913.js"><link rel="prefetch" href="/assets/js/9.0a60c476.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.ac365ac7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.29350883.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">bing随遇而安 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">首页</a></li><li class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></li><li class="nav-item"><a href="/data-structure/" class="nav-link">数据结构</a></li><li class="nav-item"><a href="/interview/" class="nav-link">面试</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">bing随遇而安 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">首页</a></li><li class="mobile-nav-item"><a href="/algorithm/" class="nav-link">算法</a></li><li class="mobile-nav-item"><a href="/data-structure/" class="nav-link">数据结构</a></li><li class="mobile-nav-item"><a href="/interview/" class="nav-link">面试</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">BING随遇而安</span> <span itemprop="address">   in Shanghai</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2022-12-10T00:00:00.000Z">
      2022-12-10
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/golang" data-v-42ccfcd5><span data-v-42ccfcd5>golang</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h1 id="内网goproxy服务搭建配置"><a href="#内网goproxy服务搭建配置" class="header-anchor">#</a> 内网goproxy服务搭建配置</h1> <h3 id="goproxy是什么"><a href="#goproxy是什么" class="header-anchor">#</a> goproxy是什么</h3> <p>goproxy是go模块代理服务，主要用来加速获取go模块。官方默认的proxy为:<a href="https://proxy.golang.org" target="_blank" rel="noopener noreferrer">https://proxy.golang.org<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 国内主要使用的proxy是由七牛云提供的<a href="https://goproxy.cn/" target="_blank" rel="noopener noreferrer">https://goproxy.cn/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="为什么要在内网搭建goproxy服务"><a href="#为什么要在内网搭建goproxy服务" class="header-anchor">#</a> 为什么要在内网搭建goproxy服务</h3> <ul><li>内网自建的goproxy不仅可以访问公网的模块，还可以访问内网的 git server</li> <li>缓存业务用到的公网第三方模块，防止公网仓库变更或者消失，导致线上编译失败或者紧急回退失败</li> <li>防止公司内部开发人员配置不当造成 import path 泄露</li> <li>cache热点依赖，提升代码编译速度等</li></ul> <h3 id="搭建流程-我们以ubuntu系统为例进行安装。primary为goproxy机器-huge-elk为研发机器"><a href="#搭建流程-我们以ubuntu系统为例进行安装。primary为goproxy机器-huge-elk为研发机器" class="header-anchor">#</a> 搭建流程(我们以ubuntu系统为例进行安装。primary为goproxy机器，huge-elk为研发机器)</h3> <h4 id="golang安装"><a href="#golang安装" class="header-anchor">#</a> golang安装</h4> <p>通过国内go资源网站studygolang下载安装:<a href="https://studygolang.com/dl" target="_blank" rel="noopener noreferrer">https://studygolang.com/dl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 下载对应系统的golang</span>
root@primary:~<span class="token comment"># wget https://studygolang.com/dl/golang/go1.19.2.linux-amd64.tar.gz</span>

<span class="token comment">## 解压到指定目录</span>
root@primary:~<span class="token comment"># tar zxvf go1.19.2.linux-amd64.tar.gz -C /usr/local</span>

<span class="token comment">## 将go命令添加到/usr/bin</span>
root@primary:/usr/bin<span class="token comment"># ln /usr/local/go/bin/go -s /usr/bin/go</span>

<span class="token comment">## 查看go命令是否安装成功</span>
root@primary:~<span class="token comment"># go version</span>
go version go1.19.2 linux/amd64
</code></pre></div><h4 id="git安装"><a href="#git安装" class="header-anchor">#</a> git安装</h4> <p>ubuntu默认已经安装git。如未安装，请通过官网下载安装:<a href="https://git-scm.com/downloads" target="_blank" rel="noopener noreferrer">https://git-scm.com/downloads<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 通过 git version命令来查看是否安装成功</span>
root@primary:~<span class="token comment"># git version</span>
<span class="token function">git</span> version <span class="token number">2.34</span>.1
</code></pre></div><h4 id="goproxy安装"><a href="#goproxy安装" class="header-anchor">#</a> goproxy安装</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 拉取goproxy代码</span>
root@primary:~<span class="token comment"># git clone https://github.com/goproxyio/goproxy.git</span>
Cloning into <span class="token string">'goproxy'</span><span class="token punctuation">..</span>.
remote: Enumerating objects: <span class="token number">530</span>, done.
remote: Counting objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">27</span>/27<span class="token punctuation">)</span>, done.
remote: Compressing objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">21</span>/21<span class="token punctuation">)</span>, done.
remote: Total <span class="token number">530</span> <span class="token punctuation">(</span>delta <span class="token number">10</span><span class="token punctuation">)</span>, reused <span class="token number">13</span> <span class="token punctuation">(</span>delta <span class="token number">6</span><span class="token punctuation">)</span>, pack-reused <span class="token number">503</span>
Receiving objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">530</span>/530<span class="token punctuation">)</span>, <span class="token number">139.72</span> KiB <span class="token operator">|</span> <span class="token number">266.00</span> KiB/s, done.
Resolving deltas: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">225</span>/225<span class="token punctuation">)</span>, done.

<span class="token comment">## 安装make</span>
root@primary:~/goproxy<span class="token comment"># apt install make -y</span>

<span class="token comment">## make安装goproxy</span>
root@primary:~<span class="token comment"># cd goproxy</span>
root@primary:~/goproxy<span class="token comment"># make</span>

go: downloading github.com/prometheus/client_golang v1.9.0
go: downloading golang.org/x/mod v0.4.0
go: downloading github.com/goproxyio/windows v0.0.0-20191126033816-f4a809841617
go: downloading github.com/prometheus/client_model v0.2.0
go: downloading github.com/prometheus/common v0.15.0
go: downloading golang.org/x/xerrors v0.0.0-20191204190536-9bdfabe68543
go: downloading github.com/beorn7/perks v1.0.1
go: downloading github.com/cespare/xxhash/v2 v2.1.1
go: downloading github.com/golang/protobuf v1.4.3
go: downloading github.com/prometheus/procfs v0.2.0
go: downloading golang.org/x/sys v0.0.0-20201214210602-f9fddec55a1e
go: downloading github.com/matttproud/golang_protobuf_extensions v1.0.1
go: downloading google.golang.org/protobuf v1.23.0
go: downloading github.com/google/go-cmp v0.4.0

<span class="token comment">## 将goproxy二进制文件移动到指定目录</span>
<span class="token comment">## 安装完成后goproxy下会多出bin目录，将bin目录移动到/usr/local/goproxy</span>
root@primary:~/goproxy<span class="token comment"># mkdir /usr/local/goproxy</span>
root@primary:~/goproxy<span class="token comment"># mv ./bin /usr/local/goproxy/</span>
root@primary:~/goproxy<span class="token comment"># cd /usr/local/goproxy/bin/</span>
root@primary:/usr/local/goproxy/bin<span class="token comment"># ll</span>
total <span class="token number">8464</span>
drwxrwxr-x <span class="token number">2</span> root root    <span class="token number">4096</span> Oct <span class="token number">31</span> <span class="token number">15</span>:15 ./
drwxr-xr-x <span class="token number">3</span> root   root      <span class="token number">4096</span> Oct <span class="token number">31</span> <span class="token number">15</span>:18 <span class="token punctuation">..</span>/
-rwxrwxr-x <span class="token number">1</span> root root <span class="token number">8658944</span> Oct <span class="token number">31</span> <span class="token number">15</span>:15 goproxy*

<span class="token comment">## 将goproxy命令添加到/usr/bin</span>
root@primary:/usr/bin<span class="token comment"># ln /usr/local/goproxy/bin/goproxy -s /usr/bin/goproxy</span>

<span class="token comment">## 查看goproxy命令是否安装成功</span>
root@primary:/usr/local/goproxy/bin<span class="token comment"># goproxy -h</span>
Usage of goproxy:
  <span class="token parameter variable">-cacheDir</span> string
    	Go Modules cache dir, default is <span class="token variable">$GOPATH</span>/pkg/mod/cache/download
  <span class="token parameter variable">-cacheExpire</span> duration
    	Go Modules cache expiration <span class="token punctuation">(</span>min<span class="token punctuation">)</span>, default is <span class="token number">5</span> min <span class="token punctuation">(</span>default 5m0s<span class="token punctuation">)</span>
  <span class="token parameter variable">-exclude</span> string
    	exclude <span class="token function">host</span> pattern, you can exclude internal Git services
  <span class="token parameter variable">-listen</span> string
    	<span class="token function">service</span> listen address <span class="token punctuation">(</span>default <span class="token string">&quot;0.0.0.0:8081&quot;</span><span class="token punctuation">)</span>
  <span class="token parameter variable">-proxy</span> string
    	next hop proxy <span class="token keyword">for</span> Go Modules, recommend use https://gopropxy.io
</code></pre></div><h4 id="goproxy命令"><a href="#goproxy命令" class="header-anchor">#</a> goproxy命令</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 执行goproxy -h命令查看goproxy命令帮助</span>
root@primary:/usr/local/goproxy/bin<span class="token comment"># goproxy -h</span>
Usage of goproxy:
  <span class="token parameter variable">-cacheDir</span> string
    	Go Modules cache dir, default is <span class="token variable">$GOPATH</span>/pkg/mod/cache/download
  <span class="token parameter variable">-cacheExpire</span> duration
    	Go Modules cache expiration <span class="token punctuation">(</span>min<span class="token punctuation">)</span>, default is <span class="token number">5</span> min <span class="token punctuation">(</span>default 5m0s<span class="token punctuation">)</span>
  <span class="token parameter variable">-exclude</span> string
    	exclude <span class="token function">host</span> pattern, you can exclude internal Git services
  <span class="token parameter variable">-listen</span> string
    	<span class="token function">service</span> listen address <span class="token punctuation">(</span>default <span class="token string">&quot;0.0.0.0:8081&quot;</span><span class="token punctuation">)</span>
  <span class="token parameter variable">-proxy</span> string
    	next hop proxy <span class="token keyword">for</span> Go Modules, recommend use https://gopropxy.io

</code></pre></div><ul><li>-cacheDir   go module缓存目录，默认$GOPATH/pkg/mod/cache/download</li> <li>-cacheExpire go module缓存时长(分钟)， 默认5分钟</li> <li>-exclude 排除指定host模式，你可以排除内部git server host</li> <li>-listen 监听host和端口， 默认0.0.0.0:8081</li> <li>-proxy  go module上游代理, 推荐使用 https://gopropxy.io</li></ul> <h4 id="启动goproxy服务"><a href="#启动goproxy服务" class="header-anchor">#</a> 启动goproxy服务</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 新建cache dir</span>
root@primary:~<span class="token comment"># mkdir /usr/local/goproxy/cache</span>

<span class="token comment">## 使用nohup命令，在后台启动goproxy进程</span>
root@primary:~<span class="token comment"># nohup goproxy -cacheDir=/usr/local/goproxy/cache -exclude=gitea.example.com -listen=0.0.0.0:80 -proxy=https://goproxy.cn &gt; /tmp/goproxy.log 2&gt;&amp;1 &amp;</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">23261</span>
root@primary:~<span class="token comment"># ps aux | grep gop</span>
root@primary:/usr/local/goproxy<span class="token comment"># ps aux | grep gop</span>
root        <span class="token number">3441</span>  <span class="token number">0.0</span>  <span class="token number">0.7</span> <span class="token number">1154944</span> <span class="token number">7376</span> pts/0    Sl   <span class="token number">19</span>:24   <span class="token number">0</span>:00 goproxy <span class="token parameter variable">-cacheDir</span><span class="token operator">=</span>/usr/local/goproxy/cache <span class="token parameter variable">-exclude</span><span class="token operator">=</span>gitea.example.com <span class="token parameter variable">-listen</span><span class="token operator">=</span><span class="token number">0.0</span>.0.0:80 <span class="token parameter variable">-proxy</span><span class="token operator">=</span>https://goproxy.cn
root        <span class="token number">3449</span>  <span class="token number">0.0</span>  <span class="token number">0.2</span>   <span class="token number">7004</span>  <span class="token number">2064</span> pts/0    S+   <span class="token number">19</span>:25   <span class="token number">0</span>:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto gop

<span class="token comment">## 查看goproxy服务机器IP地址 如果已经将域名解析到goproxy服务机器，可以直接使用域名。</span>
root@primary:~<span class="token comment"># ip addr</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span>
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: enp0s2: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc fq_codel state UP group default qlen <span class="token number">1000</span>
    link/ether ca:3b:cc:0e:10:69 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">192.168</span>.64.3/24 metric <span class="token number">100</span> brd <span class="token number">192.168</span>.64.255 scope global dynamic enp0s2
       valid_lft 74713sec preferred_lft 74713sec
    inet6 fd4a:5ec3:8409:4846:c83b:ccff:fe0e:1069/64 scope global dynamic mngtmpaddr noprefixroute
       valid_lft 2591984sec preferred_lft 604784sec
    inet6 fe80::c83b:ccff:fe0e:1069/64 scope <span class="token function">link</span>
       valid_lft forever preferred_lft forever

<span class="token comment">## 到这里我们基本的内网goproxy服务就启动了，goproxy服务的地址为:http://192.168.64.3</span>
</code></pre></div><h4 id="研发机配置goproxy"><a href="#研发机配置goproxy" class="header-anchor">#</a> 研发机配置goproxy</h4> <p>在开发机器上配置<b>GOPROXY</b>。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 研发机器继续使用ubuntu</span>
<span class="token comment">## 查看go环境变量</span>
root@huge-elk:~<span class="token comment"># go env</span>
<span class="token assign-left variable">GO111MODULE</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GOARCH</span><span class="token operator">=</span><span class="token string">&quot;amd64&quot;</span>
<span class="token assign-left variable">GOBIN</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GOCACHE</span><span class="token operator">=</span><span class="token string">&quot;/root/.cache/go-build&quot;</span>
<span class="token assign-left variable">GOENV</span><span class="token operator">=</span><span class="token string">&quot;/root/.config/go/env&quot;</span>
<span class="token assign-left variable">GOEXE</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GOEXPERIMENT</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GOFLAGS</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GOHOSTARCH</span><span class="token operator">=</span><span class="token string">&quot;amd64&quot;</span>
<span class="token assign-left variable">GOHOSTOS</span><span class="token operator">=</span><span class="token string">&quot;linux&quot;</span>
<span class="token assign-left variable">GOINSECURE</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GOMODCACHE</span><span class="token operator">=</span><span class="token string">&quot;/root/go/pkg/mod&quot;</span>
<span class="token assign-left variable">GONOPROXY</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GONOSUMDB</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GOOS</span><span class="token operator">=</span><span class="token string">&quot;linux&quot;</span>
<span class="token assign-left variable">GOPATH</span><span class="token operator">=</span><span class="token string">&quot;/root/go&quot;</span>
<span class="token assign-left variable">GOPRIVATE</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span><span class="token string">&quot;https://proxy.golang.org,direct&quot;</span>
<span class="token assign-left variable">GOROOT</span><span class="token operator">=</span><span class="token string">&quot;/usr/lib/go-1.18&quot;</span>
<span class="token assign-left variable">GOSUMDB</span><span class="token operator">=</span><span class="token string">&quot;sum.golang.org&quot;</span>
<span class="token assign-left variable">GOTMPDIR</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GOTOOLDIR</span><span class="token operator">=</span><span class="token string">&quot;/usr/lib/go-1.18/pkg/tool/linux_amd64&quot;</span>
<span class="token assign-left variable">GOVCS</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">GOVERSION</span><span class="token operator">=</span><span class="token string">&quot;go1.18.1&quot;</span>
<span class="token assign-left variable">GCCGO</span><span class="token operator">=</span><span class="token string">&quot;gccgo&quot;</span>
<span class="token assign-left variable">GOAMD64</span><span class="token operator">=</span><span class="token string">&quot;v1&quot;</span>
<span class="token assign-left variable">AR</span><span class="token operator">=</span><span class="token string">&quot;ar&quot;</span>
<span class="token assign-left variable">CC</span><span class="token operator">=</span><span class="token string">&quot;gcc&quot;</span>
<span class="token assign-left variable">CXX</span><span class="token operator">=</span><span class="token string">&quot;g++&quot;</span>
<span class="token assign-left variable">CGO_ENABLED</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span>
<span class="token assign-left variable">GOMOD</span><span class="token operator">=</span><span class="token string">&quot;/dev/null&quot;</span>
<span class="token assign-left variable">GOWORK</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">CGO_CFLAGS</span><span class="token operator">=</span><span class="token string">&quot;-g -O2&quot;</span>
<span class="token assign-left variable">CGO_CPPFLAGS</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">CGO_CXXFLAGS</span><span class="token operator">=</span><span class="token string">&quot;-g -O2&quot;</span>
<span class="token assign-left variable">CGO_FFLAGS</span><span class="token operator">=</span><span class="token string">&quot;-g -O2&quot;</span>
<span class="token assign-left variable">CGO_LDFLAGS</span><span class="token operator">=</span><span class="token string">&quot;-g -O2&quot;</span>
<span class="token assign-left variable">PKG_CONFIG</span><span class="token operator">=</span><span class="token string">&quot;pkg-config&quot;</span>
<span class="token assign-left variable">GOGCCFLAGS</span><span class="token operator">=</span><span class="token string">&quot;-fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build2599397427=/tmp/go-build -gno-record-gcc-switches&quot;</span>

<span class="token comment">## 设置GO111MODULE=on, 使用mod模式开发</span>
root@huge-elk:~<span class="token comment"># go env -w GO111MODULE=on</span>

<span class="token comment">## 将GOPROXY设置为我们配置的内网host</span>
root@huge-elk:~<span class="token comment"># go env -w GOPROXY=http://192.168.64.3,direct</span>

<span class="token comment">## 查看修改是否生效</span>
root@huge-elk:~<span class="token comment"># go env GO111MODULE GOPROXY</span>
on
http://192.168.64.3,direct

<span class="token comment">## 拉取公网go模块 </span>
root@huge-elk:~<span class="token comment"># go install github.com/fbbyqsyea/wechat@latest</span>
go: downloading github.com/fbbyqsyea/wechat v0.0.4
package github.com/fbbyqsyea/wechat is not a main package
</code></pre></div><h4 id="拉取内网gitea-go模块"><a href="#拉取内网gitea-go模块" class="header-anchor">#</a> 拉取内网gitea go模块</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 要拉取gitea代码，goproxy机器必须配置对应仓库的访问权限</span>

<span class="token comment">## 生成SSH密钥</span>
<span class="token comment">## 1. 进入 ~/.ssh目录</span>
root@primary:~<span class="token comment"># cd ~/.ssh</span>
<span class="token comment">## 2. 使用ssh-keygen命令生成rsa公私钥 id_rsa_git为秘钥名称，不要设置密码，直接按几次回车键，完成密钥创建</span>
root@primary:~/.ssh<span class="token comment"># ssh-keygen -t rsa</span>
Generating public/private rsa key pair.
Enter <span class="token function">file</span> <span class="token keyword">in</span> <span class="token function">which</span> to save the key <span class="token punctuation">(</span>/root/.ssh/id_rsa<span class="token punctuation">)</span>: id_rsa_git
Enter passphrase <span class="token punctuation">(</span>empty <span class="token keyword">for</span> no passphrase<span class="token punctuation">)</span>:
Enter same passphrase again:
Your identification has been saved <span class="token keyword">in</span> id_rsa_git
Your public key has been saved <span class="token keyword">in</span> id_rsa_git.pub
The key fingerprint is:
SHA256:URSu2NTjQomvYIyRF3U+A0XCkHT7V7AHz/1RazPCil0 root@primary
The key's randomart image is:
+---<span class="token punctuation">[</span>RSA <span class="token number">3072</span><span class="token punctuation">]</span>----+
<span class="token operator">|</span>   .<span class="token operator">+=</span><span class="token operator">=</span>o+.*.    <span class="token builtin class-name">.</span><span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token punctuation">..</span>o.B <span class="token operator">=</span> *<span class="token punctuation">..</span>  o<span class="token operator">|</span>
<span class="token operator">|</span>  o <span class="token builtin class-name">.</span> o O <span class="token operator">=</span> <span class="token operator">=</span>E.* <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token operator">=</span>   B *o+o o.+<span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token builtin class-name">.</span> + <span class="token builtin class-name">.</span> S.oo    <span class="token builtin class-name">.</span><span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> o       <span class="token operator">|</span>
<span class="token operator">|</span>      <span class="token builtin class-name">.</span>          <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>
+----<span class="token punctuation">[</span>SHA256<span class="token punctuation">]</span>-----+
root@primary:~/.ssh<span class="token comment"># ll</span>
total <span class="token number">20</span>
drwx------ <span class="token number">2</span> root root <span class="token number">4096</span> Oct <span class="token number">31</span> <span class="token number">19</span>:39 ./
drwx------ <span class="token number">8</span> root root <span class="token number">4096</span> Oct <span class="token number">31</span> <span class="token number">19</span>:37 <span class="token punctuation">..</span>/
-rw------- <span class="token number">1</span> root root  <span class="token number">562</span> Oct <span class="token number">31</span> <span class="token number">19</span>:08 authorized_keys
-rw------- <span class="token number">1</span> root root <span class="token number">2602</span> Oct <span class="token number">31</span> <span class="token number">19</span>:39 id_rsa_git
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">566</span> Oct <span class="token number">31</span> <span class="token number">19</span>:39 id_rsa_git.pub

<span class="token comment">## 配置gitea公钥</span>
<span class="token comment">## 1.获取公钥内容</span>
root@primary:~/.ssh<span class="token comment"># cat id_rsa_git.pub</span>
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCi+BCfnmWmI+6LsIfB42op5Y5a7MuxPw3PQb4uy5p/OEjDTN+XfCg763V7/0ZR0jL1Brer6zgOczm5FaVbIgbdwc7KXBE4fhqDJMdlDmWWaP71jaVbzdQnLkGE88xXqKG0gZT+n+JwJbC+ZymAkwZsOJvWa0TWIcL9MVgspyN19R8ZuvUJ6iws+rhx//6EPDa3FPkkzAD7LLkDRqb6rd+Ml8jhmN21x2aPU6R6WIXJbHqN3r5Rs9d58oHS/60e+Z2uYiHYr9oxs4Vun6YZCY2x1c5rfJOlHlOtZI9T5n2GScRykVBbNCp4OEv69Ga8xN6q2k6oQKYylF7+7J99S9nOUvX95E0sVGcNAHBupAZ4xst/y/XL8QQxNwn1+cEwuOHJp0er8qHp83kPqAn/8pQwzT+6UTfKfcj+eP9w742an9eIwtcjD1FBYvKqUkh0739vvshFBJOHSF/LQMRo8ARU8AfAxfhkTqc4O98xADwDTxKCZ3HHZNkK7SB/1XMiXiU<span class="token operator">=</span> root@primary

<span class="token comment">## 2.使用有权限的账号登录gitea并且配置公钥，配置路径:Gitea “用户设置 -&gt; SSH/GPG秘钥 -&gt; 管理 SSH 密钥 -&gt;增加秘钥</span>

<span class="token comment">## 配置本地私钥</span>
<span class="token comment">## 1.打开~/.ssh/config，添加如下内容</span>
root@primary:~<span class="token comment"># vim ~/.ssh/config</span>
root@primary:~<span class="token comment"># cat ~/.ssh/config</span>
 Host *
 HostkeyAlgorithms +ssh-rsa
 PubkeyAcceptedKeyTypes +ssh-rsa

 Host gitea.example.com
 HostName gitea.example.com
 Port <span class="token number">22</span>
 User <span class="token function">git</span>
 IdentityFile ~/.ssh/id_rsa_git

<span class="token comment">## 2. 给config文件可执行权限</span>
root@primary:~<span class="token comment"># chmod a+x ~/.ssh/config</span>

<span class="token comment">## 修改git clone方式</span>
root@primary:~/.ssh<span class="token comment"># git config --global url.&quot;ssh://git@gitea.example.com&quot;.insteadOf &quot;https://gitea.example.com&quot;</span>

<span class="token comment">## 由于gitea https证书已过期，所以设置GOINSECURE变量，忽略gitea.example.com https校验</span>
root@primary:~/.ssh<span class="token comment"># go env -w GOINSECURE=gitea.example.com</span>
root@primary:~/.ssh<span class="token comment"># go env GOINSECURE</span>
gitea.example.com

<span class="token comment">## 测试安装内网gitea项目 (研发机器)</span>
root@huge-elk:~<span class="token comment"># go install gitea.example.com/goweb/gin-framework-layout@latest</span>
go: downloading gitea.example.com/goweb/gin-framework-layout v0.0.0-20221028094355-547f7a489c3b
go: gitea.example.com/goweb/gin-framework-layout@latest: gitea.example.com/goweb/gin-framework-layout@v0.0.0-20221028094355-547f7a489c3b: verifying module: gitea.example.com/goweb/gin-framework-layout@v0.0.0-20221028094355-547f7a489c3b: reading http://192.168.64.3/sumdb/sum.golang.org/lookup/gitea.example.com/goweb/gin-framework-layout@v0.0.0-20221028094355-547f7a489c3b: <span class="token number">404</span> Not Found
	server response: not found: gitea.example.com/goweb/gin-framework-layout@v0.0.0-20221028094355-547f7a489c3b: unrecognized <span class="token function">import</span> path <span class="token string">&quot;gitea.example.com/goweb/gin-framework-layout&quot;</span><span class="token builtin class-name">:</span> https fetch: Get <span class="token string">&quot;https://gitea.example.com/goweb/gin-framework-layout?go-get=1&quot;</span><span class="token builtin class-name">:</span> dial tcp: lookup gitea.example.com on <span class="token number">8.8</span>.8.8:53: no such <span class="token function">host</span>

<span class="token comment">## 目前gin-framework-layout模块安装成功，但是sum校验失败，设置内部项目忽略校验 (研发机器)</span>
root@huge-elk:~<span class="token comment"># go env -w GONOSUMDB=gitea.example.com</span>

<span class="token comment">## 重新安装</span>
root@huge-elk:~<span class="token comment"># go clean -modcache</span>
root@huge-elk:~<span class="token comment"># go env -w GONOSUMDB=gitea.example.com</span>
root@huge-elk:~<span class="token comment"># go install gitea.example.com/goweb/gin-framework-layout@latest</span>
go: downloading gitea.example.com/goweb/gin-framework-layout v0.0.0-20221028094355-547f7a489c3b
go: downloading gitea.example.com/goweb/gin-framework-core v0.0.1
go: downloading github.com/gin-gonic/gin v1.8.1
go: downloading github.com/go-redis/redis v6.15.9+incompatible
go: downloading github.com/go-sql-driver/mysql v1.6.0
go: downloading github.com/jmoiron/sqlx v1.3.5
go: downloading github.com/spf13/viper v1.13.0
go: downloading go.uber.org/zap v1.23.0
go: downloading gopkg.in/natefinch/lumberjack.v2 v2.0.0
go: downloading github.com/Masterminds/squirrel v1.5.3
go: downloading github.com/mcuadros/go-defaults v1.2.0
go: downloading github.com/gin-contrib/sse v0.1.0
go: downloading github.com/mattn/go-isatty v0.0.14
go: downloading golang.org/x/net v0.1.0
go: downloading github.com/fsnotify/fsnotify v1.5.4
go: downloading github.com/mitchellh/mapstructure v1.5.0
go: downloading github.com/spf13/afero v1.8.2
go: downloading github.com/spf13/cast v1.5.0
go: downloading github.com/spf13/jwalterweatherman v1.1.0
go: downloading github.com/spf13/pflag v1.0.5
go: downloading go.uber.org/atomic v1.7.0
go: downloading go.uber.org/multierr v1.6.0
go: downloading gitea.example.com/goweb/go-utils v0.0.0-20221028065316-8abebfd58706
go: downloading github.com/dgrijalva/jwt-go v3.2.0+incompatible
go: downloading github.com/lann/builder v0.0.0-20180802200727-47ae307949d0
go: downloading github.com/go-playground/validator/v10 v10.10.0
go: downloading github.com/pelletier/go-toml/v2 v2.0.5
go: downloading github.com/pelletier/go-toml v1.9.5
go: downloading github.com/ugorji/go/codec v1.2.7
go: downloading google.golang.org/protobuf v1.28.0
go: downloading gopkg.in/yaml.v2 v2.4.0
go: downloading golang.org/x/sys v0.1.0
go: downloading golang.org/x/text v0.4.0
go: downloading github.com/subosito/gotenv v1.4.1
go: downloading github.com/hashicorp/hcl v1.0.0
go: downloading gopkg.in/ini.v1 v1.67.0
go: downloading github.com/magiconair/properties v1.8.6
go: downloading gopkg.in/yaml.v3 v3.0.1
go: downloading github.com/lann/ps v0.0.0-20150810152359-62de8c46ede0
go: downloading github.com/go-playground/universal-translator v0.18.0
go: downloading github.com/leodido/go-urn v1.2.1
go: downloading golang.org/x/crypto v0.0.0-20220411220226-7b82a4e95df4
go: downloading github.com/go-playground/locales v0.14.0



<span class="token comment"># gitea.example.com/goweb/gin-framework-layout</span>
go/pkg/mod/gitea.example.com/goweb/gin-framework-layout@v0.0.0-20221028094355-547f7a489c3b/main.go:9:7: undefined: core.New
note: module requires Go <span class="token number">1.19</span>


到这里我们内网goproxy服务搭建配置成功
</code></pre></div></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h3 active"><a href="#goproxy是什么" title="goproxy是什么">goproxy是什么</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#为什么要在内网搭建goproxy服务" title="为什么要在内网搭建goproxy服务">为什么要在内网搭建goproxy服务</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#搭建流程-我们以ubuntu系统为例进行安装。primary为goproxy机器-huge-elk为研发机器" title="搭建流程(我们以ubuntu系统为例进行安装。primary为goproxy机器，huge-elk为研发机器)">搭建流程(我们以ubuntu系统为例进行安装。primary为goproxy机器，huge-elk为研发机器)</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/fbbyqsyea" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8>MIT Licensed | Copyright © 2024-fbbyqsyea</li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a96450f7.js" defer></script><script src="/assets/js/6.38d57c41.js" defer></script><script src="/assets/js/3.122d5fd9.js" defer></script><script src="/assets/js/31.619710f3.js" defer></script>
  </body>
</html>
