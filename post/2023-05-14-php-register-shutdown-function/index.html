<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.117.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>PHP register shutdown function &middot; bing随遇而安</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  
  
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

  
  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://fbbmore.com/"><h1>bing随遇而安</h1></a>
      <p class="lead">
       废柴都是间歇性的自虐 强者却是持续性的自律 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://fbbmore.com/">首页</a> </li>
        <li><a href="https://fbbmore.com//tags">标签</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>PHP register shutdown function</h1>
  <time datetime=2023-05-14T18:59:00Z class="post-date">Sun, May 14, 2023</time>
  <h2 id="问题">问题</h2>
<p>最近业务上需要调用一个响应格式为<strong>event stream</strong>的接口，需要实现下面两点功能。</p>
<ul>
<li>请求响应格式为<strong>event stream</strong>的接口，同时实时的将流式数据输出给前端。</li>
<li>请求结束后将格式化后的流式数据存储到日志中。</li>
</ul>
<p>我们使用curl的write function 回调函数来处理流式数据的输出。但是如果在event stream请求的过程中如果前端中断请求或者说发生异常，就会出现日志丢失的情况。为了实现不管是请求中断还是发生异常，我们都可以将已有的流式数据和异常数据存储到日志的功能，我们可以使用php的register_shutdown_function来注册一个shutdown回调函数。这样不管是正常请求结束还是异常的请求退出，我们都可以记录相关的已有数据。下面我们就一起来学习一下php的register_shutdown_functioon。</p>
<h2 id="用法">用法</h2>
<p>register_shutdown_function()函数在PHP中注册一个在脚本终止时执行的回调函数。这很有用,可以执行清理操作。</p>
<h4 id="语法">语法:</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a6e22e">register_shutdown_function</span>(<span style="color:#a6e22e">callback</span>)
</span></span></code></pre></div><h4 id="例子">例子:</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">register_shutdown_function</span>(<span style="color:#e6db74">&#39;cleanup&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">cleanup</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 关闭数据库连接,关闭打开的文件等
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;清理!&#39;</span>; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;脚本执行中...&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>即使脚本正常结束,或由exit(),die()或致命错误终止,关闭函数也会被调用。
一些重要点:</p>
<ul>
<li>可以注册多个shutdown函数。它们将以相反的注册顺序执行。</li>
<li>从shutdown函数内部注册shutdown函数将导致未定义的行为。</li>
<li>shutdown函数可以死亡,但其余的shutdown函数仍将被调用。</li>
<li>即使页面已经发送,shutdown函数也会执行,所以无法从shutdown函数内发送标头。
总之,register_shutdown_function()允许您在PHP脚本终止时执行重要的清理代码,以避免未预期的副作用。</li>
</ul>
<p>主要用途:</p>
<ul>
<li>关闭数据库连接</li>
<li>释放锁</li>
<li>关闭打开的文件/网络连接</li>
<li>日志记录</li>
<li>清理临时文件
这可以确保您的脚本即使在发生意外情况下也可以正确地清理资源。</li>
</ul>
<h2 id="解答">解答</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#75715e">// 注册请求终止回调函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">register_shutdown_function</span>(<span style="color:#66d9ef">function</span> ($requestParams) <span style="color:#66d9ef">use</span> (<span style="color:#f92672">&amp;</span>$output){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">log</span>(
</span></span><span style="display:flex;"><span>        $requestParams, <span style="color:#75715e">// 调用流式接口的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $output, <span style="color:#75715e">// 流式接口实时响应的数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">connection_aborted</span>(), <span style="color:#75715e">// 客户端是否已关闭与服务器的连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">error_get_last</span>(), <span style="color:#75715e">// 错误信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>}, $requestParams);
</span></span></code></pre></div>
</div>


    </main>

    
      
    
  </body>
</html>
