<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.117.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>启动k8s服务 &middot; bing随遇而安</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  
  
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

  
  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://fbbmore.com/"><h1>bing随遇而安</h1></a>
      <p class="lead">
       废柴都是间歇性的自虐 强者却是持续性的自律 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://fbbmore.com/">首页</a> </li>
        <li><a href="https://fbbmore.com//tags">标签</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>启动k8s服务</h1>
  <time datetime=2022-03-17T00:00:00Z class="post-date">Thu, Mar 17, 2022</time>
  <h3 id="kubeadmkubeletkubectl简介">kubeadm、kubelet、kubectl简介</h3>
<p>参照前一篇的文章，在k8s-master和k8s-node节点上都安装了kubeadm、kubelet、kubectl服务。</p>
<p>Kubeadm是一个提供了 kubeadm init 和 kubeadm join 的工具，作为创建 Kubernetes 集群的 “快捷途径” 的最佳实践。kubeadm 通过执行必要的操作来启动和运行最小可用集群。 按照设计，它只关注启动引导，而非配置机器。同样的， 安装各种 “锦上添花” 的扩展，例如 Kubernetes Dashboard、 监控方案、以及特定云平台的扩展，都不在讨论范围内。相反，我们希望在 kubeadm 之上构建更高级别以及更加合规的工具， 理想情况下，使用 kubeadm 作为所有部署工作的基准将会更加易于创建一致性集群。</p>
<p>kubelet 是在每个 Node 节点上运行的主要 “节点代理”。它可以使用以下之一向 apiserver 注册： 主机名（hostname）；覆盖主机名的参数；某云驱动的特定逻辑。kubelet 是基于 PodSpec 来工作的。每个 PodSpec 是一个描述 Pod 的 YAML 或 JSON 对象。 kubelet 接受通过各种机制（主要是通过 apiserver）提供的一组 PodSpec，并确保这些 PodSpec 中描述的容器处于运行状态且运行状况良好。 kubelet 不管理不是由 Kubernetes 创建的容器。</p>
<p>你可以使用 Kubectl 命令行工具管理 Kubernetes 集群。 kubectl 在 $HOME/.kube 目录中查找一个名为 config 的配置文件。 你可以通过设置 KUBECONFIG 环境变量或设置 &ndash;kubeconfig 参数来指定其它 kubeconfig 文件。</p>
<h3 id="启动master节点">启动master节点</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 在master机器商运行如下明令</span>
</span></span><span style="display:flex;"><span>$ sudo kubeadm init --control-plane-endpoint <span style="color:#e6db74">&#34;k8s.cnblogs.com:6443&#34;</span> --upload-certs --image-repository registry.aliyuncs.com/google_containers --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --control-plane-endpoint string 为控制平面指定一个稳定的 IP 地址或 DNS 名称。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --upload-certs 将控制平面证书上传到 kubeadm-certs Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --image-repository string     默认值：&#34;k8s.gcr.io&#34; 选择用于拉取控制平面镜像的容器仓库</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --pod-network-cidr string 指明 pod 网络可以使用的 IP 地址段。如果设置了这个参数，控制平面将会为每一个节点自动分配 CIDRs。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装成功后显示以下提示信息 按照提示信息操作</span>
</span></span><span style="display:flex;"><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Alternatively, <span style="color:#66d9ef">if</span> you are the root user, you can run:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You can now join any number of the control-plane node running the following command on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  kubeadm join k8s.cnblogs.com:6443 --token g4mcrb.9tzs4qwkuk4ccdkl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --discovery-token-ca-cert-hash sha256:1c0ae36b1c28ea6c7d3092f85614fed02281be851034c04cd3260792f0481f98 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --control-plane --certificate-key 7bb2e92f9fbf21eb05b2dc88e19de2dbbdd9471dea646c8fc9fdaa099e8661c9
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style="display:flex;"><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubeadm join k8s.cnblogs.com:6443 --token g4mcrb.9tzs4qwkuk4ccdkl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --discovery-token-ca-cert-hash sha256:1c0ae36b1c28ea6c7d3092f85614fed02281be851034c04cd3260792f0481f98 
</span></span></code></pre></div><h3 id="以非管理员身份运行kubectl">以非管理员身份运行kubectl</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># master节点</span>
</span></span><span style="display:flex;"><span>$  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>$  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># node节点</span>
</span></span><span style="display:flex;"><span>$  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从master节点复制文件</span>
</span></span><span style="display:flex;"><span>$  sudo scp /etc/kubernetes/admin.conf 192.168.64.130:/usr/local/webdata/.kube/config
</span></span><span style="display:flex;"><span>$  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span></code></pre></div><h3 id="在node节点上加入k8s集群">在node节点上加入k8s集群</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 在node节点host增加k8s.cnblogs.com解析 解析到master节点ip</span>
</span></span><span style="display:flex;"><span>$ echo 192.168.64.128 k8s.cnblogs.com &gt;&gt; /etc/hosts
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加入k8s集群</span>
</span></span><span style="display:flex;"><span>$ kubeadm join k8s.cnblogs.com:6443 --token g4mcrb.9tzs4qwkuk4ccdkl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --discovery-token-ca-cert-hash sha256:1c0ae36b1c28ea6c7d3092f85614fed02281be851034c04cd3260792f0481f98 
</span></span></code></pre></div><h3 id="查看集群情况">查看集群情况</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl cluster-info
</span></span><span style="display:flex;"><span>Kubernetes control plane is running at https://k8s.cnblogs.com:6443
</span></span><span style="display:flex;"><span>CoreDNS is running at https://k8s.cnblogs.com:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To further debug and diagnose cluster problems, use <span style="color:#e6db74">&#39;kubectl cluster-info dump&#39;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl get node
</span></span><span style="display:flex;"><span>NAME             STATUS   ROLES                  AGE     VERSION
</span></span><span style="display:flex;"><span>192.168.64.128   Ready    control-plane,master   111m    v1.23.4
</span></span><span style="display:flex;"><span>192.168.64.129   Ready    &lt;none&gt;                 6m32s   v1.23.4
</span></span><span style="display:flex;"><span>192.168.64.130   Ready    &lt;none&gt;                 7m5s    v1.23.4
</span></span></code></pre></div><h3 id="安装pod网络">安装POD网络</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 要让Kubernetes Cluster能够工作，必须安装Pod网络，否则Pod之间无法通信。Kubernetes支持多种网络方案，这里我们先使用flannel。</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span></span></code></pre></div>
</div>


    </main>

    
      
    
  </body>
</html>
