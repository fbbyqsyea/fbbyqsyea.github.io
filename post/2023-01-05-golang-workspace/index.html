<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.117.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>go workspace简单使用 &middot; bing随遇而安</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="/css/poole.css">
  <link type="text/css" rel="stylesheet" href="/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  
  
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

  
  
</head>

  <body class="theme-base-0c ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="/"><h1>bing随遇而安</h1></a>
      <p class="lead">
       废柴都是间歇性的自虐 强者却是持续性的自律 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="/">首页</a> </li>
        <li><a href="//tags">标签</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>go workspace简单使用</h1>
  <time datetime=2023-01-05T00:00:00Z class="post-date">Thu, Jan 5, 2023</time>
  <h2 id="为什么会有go-workspace">为什么会有go workspace</h2>
<p>基于Go Module的开发，代码组织有以下两种方式:</p>
<ul>
<li>整个项目为一个Module，Module下再拆分为多个功能包</li>
<li>根据不同功能将项目拆分为多个Module</li>
</ul>
<p>两种方式各有优缺点，其中:</p>
<ul>
<li>整个项目为一个Module，各个功能包都在一个Module下，代码变更是实时生效的。但是其中业务代码和功能代码等放在一起，高度耦合。多个项目之间的公共代码不方便共享。</li>
<li>根据不同功能将项目拆分为多个Module，优点是代码之前低耦合，Module之间根据需要相互依赖。缺点是项目依赖的Module改动后，如果用到的改动后的功能就需要先发布依赖Module到代码仓库，然后在项目中更新依赖Module。</li>
</ul>
<p>针对上面所说的将项目拆分成多个Module，依赖Module需要先发布再更新的问题，有以下两个解决方案:</p>
<ul>
<li>使用Go Module中的replace指令，在项目中将依赖替换为本地Module</li>
<li>使用go workspace工作区模式，使用统一的go.work来维护依赖映射</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">xxxxxxx</span><span style="color:#f92672">/</span><span style="color:#a6e22e">gin</span><span style="color:#f92672">-</span><span style="color:#a6e22e">framework</span><span style="color:#f92672">-</span><span style="color:#a6e22e">layout</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">go</span> <span style="color:#ae81ff">1.19</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">require</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">xxxxxxx</span><span style="color:#f92672">/</span><span style="color:#a6e22e">gin</span><span style="color:#f92672">-</span><span style="color:#a6e22e">framework</span><span style="color:#f92672">-</span><span style="color:#a6e22e">core</span> <span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.0.1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">xxxxxxx</span><span style="color:#f92672">/</span><span style="color:#66d9ef">go</span><span style="color:#f92672">-</span><span style="color:#a6e22e">utils</span> <span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.0.0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20221028065316</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span><span style="color:#a6e22e">abebfd58706</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">dgrijalva</span><span style="color:#f92672">/</span><span style="color:#a6e22e">jwt</span><span style="color:#f92672">-</span><span style="color:#66d9ef">go</span> <span style="color:#a6e22e">v3</span><span style="color:#ae81ff">.2.0</span><span style="color:#f92672">+</span><span style="color:#a6e22e">incompatible</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">gin</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gonic</span><span style="color:#f92672">/</span><span style="color:#a6e22e">gin</span> <span style="color:#a6e22e">v1</span><span style="color:#ae81ff">.8.1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">swaggo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">files</span> <span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.0.0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20220728132757</span><span style="color:#f92672">-</span><span style="color:#ae81ff">551</span><span style="color:#a6e22e">d4a08d97a</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">swaggo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">gin</span><span style="color:#f92672">-</span><span style="color:#a6e22e">swagger</span> <span style="color:#a6e22e">v1</span><span style="color:#ae81ff">.5.3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">swaggo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">swag</span> <span style="color:#a6e22e">v1</span><span style="color:#ae81ff">.8.7</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">replace</span> <span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">xxxxxxx</span><span style="color:#f92672">/</span><span style="color:#a6e22e">gin</span><span style="color:#f92672">-</span><span style="color:#a6e22e">framework</span><span style="color:#f92672">-</span><span style="color:#a6e22e">core</span> =&gt; ..<span style="color:#f92672">/</span><span style="color:#a6e22e">gin</span><span style="color:#f92672">-</span><span style="color:#a6e22e">framework</span><span style="color:#f92672">-</span><span style="color:#a6e22e">core</span> <span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.0.1</span>
</span></span></code></pre></div><ol>
<li>replace在开发项目的go.mod文件中将依赖Module使用replace指令替换为本地项目。优点是不需要每次都发布和更新Module，缺点是在每次发布的时候都需要注释掉本地的replace指令。</li>
<li>go workspace工作区模式，是在项目的同级目录创建go.work文件，来使用go.work文件来统一维护当前目录下所有Module之间的依赖，同时也不需要将go.work纳入版本管理，也不需要每次都去删掉或者注释掉相关内容。具体如何使用go workspace,请参照下面示例。</li>
</ol>
<h2 id="go-workspace的用法">go workspace的用法</h2>
<p>我们以的xxxxxxx框架为例，为了代码之间低耦合，我们将框架拆封为三个Module。</p>
<ul>
<li><a href="https://github.com/xxxxxxx/gin-framework-core">gin-framework-core</a> Module, 基于gin封装的web框架核心，包括加载配置服务、日志服务、数据库操作和redis换成操作等，依赖于函数库go-utils。</li>
<li><a href="https://github.com/xxxxxxx/go-utils">go-utils</a> Module, go公共函数库，公共函数都放在这个Module下面，包括md5、http request、nodelog等封装。</li>
<li><a href="https://github.com/xxxxxxx/gin-framework-layout">gin-framework-layout</a> Module, 基于gin框架封装的业务开发模版，其内部实现了mvc+router服务，依赖于gin-framework-core和go-utils Module。</li>
</ul>
<p>我们在开发过程中需要同时改到上面三个Module，同时我们希望改动能够实时生效、发布代码到gitea时也不改动任何配置。具体可以这样做:</p>
<h6 id="新建go代码目录">新建go代码目录</h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@huge-elk:~# mkdir ~/webdata/go -p
</span></span><span style="display:flex;"><span>root@huge-elk:~# cd ~/webdata/go/
</span></span><span style="display:flex;"><span>root@huge-elk:~/webdata/go# 
</span></span></code></pre></div><h6 id="拉取gin-framework-coregin-framework-layoutgo-utils三个仓库">拉取gin-framework-core,gin-framework-layout,go-utils三个仓库</h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@huge-elk:~/webdata/go# git clone git@github.com:xxxxxxx/gin-framework-core.git
</span></span><span style="display:flex;"><span>Cloning into <span style="color:#e6db74">&#39;gin-framework-core&#39;</span>...
</span></span><span style="display:flex;"><span>The authenticity of host <span style="color:#e6db74">&#39;github.com (192.168.74.97)&#39;</span> can<span style="color:#e6db74">&#39;t be established.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RSA key fingerprint is SHA256:oltXuIRprs+uMUAwCCYY3qiLjQDmE0lP4eINNqxB1sw.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">This key is not known by any other names
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Warning: Permanently added &#39;</span>github.com<span style="color:#e6db74">&#39; (RSA) to the list of known hosts.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">remote: Enumerating objects: 40, done.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">remote: Counting objects: 100% (40/40), done.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">remote: Compressing objects: 100% (40/40), done.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">remote: Total 40 (delta 14), reused 0 (delta 0)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Receiving objects: 100% (40/40), 34.46 KiB | 1.08 MiB/s, done.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Resolving deltas: 100% (14/14), done.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">root@huge-elk:~/webdata/go# git clone git@github.com:xxxxxxx/gin-framework-layout.git
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Cloning into &#39;</span>gin-framework-layout<span style="color:#e6db74">&#39;...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">remote: Enumerating objects: 35, done.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">remote: Counting objects: 100% (35/35), done.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">remote: Compressing objects: 100% (30/30), done.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">remote: Total 35 (delta 8), reused 0 (delta 0)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Receiving objects: 100% (35/35), 32.98 KiB | 2.20 MiB/s, done.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Resolving deltas: 100% (8/8), done.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">root@huge-elk:~/webdata/go# git clone git@github.com:xxxxxxx/go-utils.git
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Cloning into &#39;</span>go-utils<span style="color:#960050;background-color:#1e0010">&#39;</span>...
</span></span><span style="display:flex;"><span>remote: Enumerating objects: 16, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>remote: Counting objects: 100% <span style="color:#f92672">(</span>16/16<span style="color:#f92672">)</span>, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>remote: Compressing objects: 100% <span style="color:#f92672">(</span>11/11<span style="color:#f92672">)</span>, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>remote: Total <span style="color:#ae81ff">16</span> <span style="color:#f92672">(</span>delta 0<span style="color:#f92672">)</span>, reused <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>delta 0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Receiving objects: 100% <span style="color:#f92672">(</span>16/16<span style="color:#f92672">)</span>, 4.27 KiB | 874.00 KiB/s, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>root@huge-elk:~/webdata/go# ll
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">5</span> root root <span style="color:#ae81ff">4096</span> Nov  <span style="color:#ae81ff">2</span> 10:19 ./
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">3</span> root root <span style="color:#ae81ff">4096</span> Nov  <span style="color:#ae81ff">2</span> 10:15 ../
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">5</span> root root <span style="color:#ae81ff">4096</span> Nov  <span style="color:#ae81ff">2</span> 10:19 gin-framework-core/
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">7</span> root root <span style="color:#ae81ff">4096</span> Nov  <span style="color:#ae81ff">2</span> 10:19 gin-framework-layout/
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">7</span> root root <span style="color:#ae81ff">4096</span> Nov  <span style="color:#ae81ff">2</span> 10:19 go-utils/
</span></span><span style="display:flex;"><span>root@huge-elk:~/webdata/go# 
</span></span></code></pre></div><h6 id="使用go-work-init来创建workspace">使用go work init来创建workspace</h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># moddirs是Go Module所在的本地目录。如果有多个Go Module，就用空格分开。如果go work init后面没有参数，会创建一个空的workspace。</span>
</span></span><span style="display:flex;"><span>go work init <span style="color:#f92672">[</span>moddirs<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 初始化workspace</span>
</span></span><span style="display:flex;"><span>root@huge-elk:~/webdata/go# go work init ./gin-framework-layout
</span></span><span style="display:flex;"><span>root@huge-elk:~/webdata/go# ll
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">5</span> root root <span style="color:#ae81ff">4096</span> Nov  <span style="color:#ae81ff">2</span> 10:22 ./
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">3</span> root root <span style="color:#ae81ff">4096</span> Nov  <span style="color:#ae81ff">2</span> 10:15 ../
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">5</span> root root <span style="color:#ae81ff">4096</span> Nov  <span style="color:#ae81ff">2</span> 10:19 gin-framework-core/
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">7</span> root root <span style="color:#ae81ff">4096</span> Nov  <span style="color:#ae81ff">2</span> 10:19 gin-framework-layout/
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">7</span> root root <span style="color:#ae81ff">4096</span> Nov  <span style="color:#ae81ff">2</span> 10:19 go-utils/
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root   <span style="color:#ae81ff">36</span> Nov  <span style="color:#ae81ff">2</span> 10:22 go.work
</span></span><span style="display:flex;"><span>root@huge-elk:~/webdata/go# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看workspace内容</span>
</span></span><span style="display:flex;"><span>root@huge-elk:~/webdata/go# cat go.work 
</span></span><span style="display:flex;"><span>go 1.18
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use ./gin-framework-layout
</span></span><span style="display:flex;"><span>root@huge-elk:~/webdata/go# 
</span></span></code></pre></div><h6 id="使用go-work-use来添加依赖">使用go work use来添加依赖</h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 如果要给workspace新增Go Module，可以使用如下命令.或者手动编辑go work文件。如果带有-r参数，会递归查找-r后面的路径参数下的所有子目录，把所有包含go.mod文件的子目录都添加到go work文件中。</span>
</span></span><span style="display:flex;"><span>go work use <span style="color:#f92672">[</span>-r<span style="color:#f92672">]</span> moddir
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### 注意: 如果某个Go Module的目录已经被加到go.work里了，后面该目录没有go.mod文件了或者该目录被删除了，那对该目录再次执行go work use命令，该目录的use指令会从go.work文件里自动移除。(注意：自动移除要从Go 1.18正式版本才会生效，Go 1.18beta1版本有bug，自动删除不会生效)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加gin-framework-core,go-utils依赖</span>
</span></span><span style="display:flex;"><span>root@huge-elk:~/webdata/go# go work use ./gin-framework-core ./go-utils/
</span></span><span style="display:flex;"><span>root@huge-elk:~/webdata/go# cat go.work 
</span></span><span style="display:flex;"><span>go 1.18
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        ./gin-framework-core
</span></span><span style="display:flex;"><span>        ./gin-framework-layout
</span></span><span style="display:flex;"><span>        ./go-utils
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>这样我们就可以修改go目录下的三个module中的任意一个，代码是实时生效的。而且对于代码发布流程不会有任何影响。</p>

</div>


    </main>

    
      
    
  </body>
</html>
