<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.117.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>内网goproxy服务搭建配置 &middot; bing随遇而安</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  
  
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

  
  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://fbbmore.com/"><h1>bing随遇而安</h1></a>
      <p class="lead">
       废柴都是间歇性的自虐 强者却是持续性的自律 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://fbbmore.com/">首页</a> </li>
        <li><a href="https://fbbmore.com//tags">标签</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>内网goproxy服务搭建配置</h1>
  <time datetime=2022-12-10T00:00:00Z class="post-date">Sat, Dec 10, 2022</time>
  <h3 id="goproxy是什么">goproxy是什么</h3>
<p>goproxy是go模块代理服务，主要用来加速获取go模块。官方默认的proxy为:<a href="https://proxy.golang.org">https://proxy.golang.org</a>, 国内主要使用的proxy是由七牛云提供的<a href="https://goproxy.cn/">https://goproxy.cn/</a>。</p>
<h3 id="为什么要在内网搭建goproxy服务">为什么要在内网搭建goproxy服务</h3>
<ul>
<li>内网自建的goproxy不仅可以访问公网的模块，还可以访问内网的 git server</li>
<li>缓存业务用到的公网第三方模块，防止公网仓库变更或者消失，导致线上编译失败或者紧急回退失败</li>
<li>防止公司内部开发人员配置不当造成 import path 泄露</li>
<li>cache热点依赖，提升代码编译速度等</li>
</ul>
<h3 id="搭建流程我们以ubuntu系统为例进行安装primary为goproxy机器huge-elk为研发机器">搭建流程(我们以ubuntu系统为例进行安装。primary为goproxy机器，huge-elk为研发机器)</h3>
<h4 id="golang安装">golang安装</h4>
<p>通过国内go资源网站studygolang下载安装:<a href="https://studygolang.com/dl">https://studygolang.com/dl</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">## 下载对应系统的golang</span>
</span></span><span style="display:flex;"><span>root@primary:~# wget https://studygolang.com/dl/golang/go1.19.2.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 解压到指定目录</span>
</span></span><span style="display:flex;"><span>root@primary:~# tar zxvf go1.19.2.linux-amd64.tar.gz -C /usr/local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 将go命令添加到/usr/bin</span>
</span></span><span style="display:flex;"><span>root@primary:/usr/bin# ln /usr/local/go/bin/go -s /usr/bin/go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看go命令是否安装成功</span>
</span></span><span style="display:flex;"><span>root@primary:~# go version
</span></span><span style="display:flex;"><span>go version go1.19.2 linux/amd64
</span></span></code></pre></div><h4 id="git安装">git安装</h4>
<p>ubuntu默认已经安装git。如未安装，请通过官网下载安装:<a href="https://git-scm.com/downloads">https://git-scm.com/downloads</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 通过 git version命令来查看是否安装成功</span>
</span></span><span style="display:flex;"><span>root@primary:~# git version
</span></span><span style="display:flex;"><span>git version 2.34.1
</span></span></code></pre></div><h4 id="goproxy安装">goproxy安装</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">## 拉取goproxy代码</span>
</span></span><span style="display:flex;"><span>root@primary:~# git clone https://github.com/goproxyio/goproxy.git
</span></span><span style="display:flex;"><span>Cloning into <span style="color:#e6db74">&#39;goproxy&#39;</span>...
</span></span><span style="display:flex;"><span>remote: Enumerating objects: 530, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>remote: Counting objects: 100% <span style="color:#f92672">(</span>27/27<span style="color:#f92672">)</span>, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>remote: Compressing objects: 100% <span style="color:#f92672">(</span>21/21<span style="color:#f92672">)</span>, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>remote: Total <span style="color:#ae81ff">530</span> <span style="color:#f92672">(</span>delta 10<span style="color:#f92672">)</span>, reused <span style="color:#ae81ff">13</span> <span style="color:#f92672">(</span>delta 6<span style="color:#f92672">)</span>, pack-reused <span style="color:#ae81ff">503</span>
</span></span><span style="display:flex;"><span>Receiving objects: 100% <span style="color:#f92672">(</span>530/530<span style="color:#f92672">)</span>, 139.72 KiB | 266.00 KiB/s, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>Resolving deltas: 100% <span style="color:#f92672">(</span>225/225<span style="color:#f92672">)</span>, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 安装make</span>
</span></span><span style="display:flex;"><span>root@primary:~/goproxy# apt install make -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## make安装goproxy</span>
</span></span><span style="display:flex;"><span>root@primary:~# cd goproxy
</span></span><span style="display:flex;"><span>root@primary:~/goproxy# make
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go: downloading github.com/prometheus/client_golang v1.9.0
</span></span><span style="display:flex;"><span>go: downloading golang.org/x/mod v0.4.0
</span></span><span style="display:flex;"><span>go: downloading github.com/goproxyio/windows v0.0.0-20191126033816-f4a809841617
</span></span><span style="display:flex;"><span>go: downloading github.com/prometheus/client_model v0.2.0
</span></span><span style="display:flex;"><span>go: downloading github.com/prometheus/common v0.15.0
</span></span><span style="display:flex;"><span>go: downloading golang.org/x/xerrors v0.0.0-20191204190536-9bdfabe68543
</span></span><span style="display:flex;"><span>go: downloading github.com/beorn7/perks v1.0.1
</span></span><span style="display:flex;"><span>go: downloading github.com/cespare/xxhash/v2 v2.1.1
</span></span><span style="display:flex;"><span>go: downloading github.com/golang/protobuf v1.4.3
</span></span><span style="display:flex;"><span>go: downloading github.com/prometheus/procfs v0.2.0
</span></span><span style="display:flex;"><span>go: downloading golang.org/x/sys v0.0.0-20201214210602-f9fddec55a1e
</span></span><span style="display:flex;"><span>go: downloading github.com/matttproud/golang_protobuf_extensions v1.0.1
</span></span><span style="display:flex;"><span>go: downloading google.golang.org/protobuf v1.23.0
</span></span><span style="display:flex;"><span>go: downloading github.com/google/go-cmp v0.4.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 将goproxy二进制文件移动到指定目录</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 安装完成后goproxy下会多出bin目录，将bin目录移动到/usr/local/goproxy</span>
</span></span><span style="display:flex;"><span>root@primary:~/goproxy# mkdir /usr/local/goproxy
</span></span><span style="display:flex;"><span>root@primary:~/goproxy# mv ./bin /usr/local/goproxy/
</span></span><span style="display:flex;"><span>root@primary:~/goproxy# cd /usr/local/goproxy/bin/
</span></span><span style="display:flex;"><span>root@primary:/usr/local/goproxy/bin# ll
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">8464</span>
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">2</span> root root    <span style="color:#ae81ff">4096</span> Oct <span style="color:#ae81ff">31</span> 15:15 ./
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">3</span> root   root      <span style="color:#ae81ff">4096</span> Oct <span style="color:#ae81ff">31</span> 15:18 ../
</span></span><span style="display:flex;"><span>-rwxrwxr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">8658944</span> Oct <span style="color:#ae81ff">31</span> 15:15 goproxy*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 将goproxy命令添加到/usr/bin</span>
</span></span><span style="display:flex;"><span>root@primary:/usr/bin# ln /usr/local/goproxy/bin/goproxy -s /usr/bin/goproxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看goproxy命令是否安装成功</span>
</span></span><span style="display:flex;"><span>root@primary:/usr/local/goproxy/bin# goproxy -h
</span></span><span style="display:flex;"><span>Usage of goproxy:
</span></span><span style="display:flex;"><span>  -cacheDir string
</span></span><span style="display:flex;"><span>    	Go Modules cache dir, default is $GOPATH/pkg/mod/cache/download
</span></span><span style="display:flex;"><span>  -cacheExpire duration
</span></span><span style="display:flex;"><span>    	Go Modules cache expiration <span style="color:#f92672">(</span>min<span style="color:#f92672">)</span>, default is <span style="color:#ae81ff">5</span> min <span style="color:#f92672">(</span>default 5m0s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -exclude string
</span></span><span style="display:flex;"><span>    	exclude host pattern, you can exclude internal Git services
</span></span><span style="display:flex;"><span>  -listen string
</span></span><span style="display:flex;"><span>    	service listen address <span style="color:#f92672">(</span>default <span style="color:#e6db74">&#34;0.0.0.0:8081&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -proxy string
</span></span><span style="display:flex;"><span>    	next hop proxy <span style="color:#66d9ef">for</span> Go Modules, recommend use https://gopropxy.io
</span></span></code></pre></div><h4 id="goproxy命令">goproxy命令</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">## 执行goproxy -h命令查看goproxy命令帮助</span>
</span></span><span style="display:flex;"><span>root@primary:/usr/local/goproxy/bin# goproxy -h
</span></span><span style="display:flex;"><span>Usage of goproxy:
</span></span><span style="display:flex;"><span>  -cacheDir string
</span></span><span style="display:flex;"><span>    	Go Modules cache dir, default is $GOPATH/pkg/mod/cache/download
</span></span><span style="display:flex;"><span>  -cacheExpire duration
</span></span><span style="display:flex;"><span>    	Go Modules cache expiration <span style="color:#f92672">(</span>min<span style="color:#f92672">)</span>, default is <span style="color:#ae81ff">5</span> min <span style="color:#f92672">(</span>default 5m0s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -exclude string
</span></span><span style="display:flex;"><span>    	exclude host pattern, you can exclude internal Git services
</span></span><span style="display:flex;"><span>  -listen string
</span></span><span style="display:flex;"><span>    	service listen address <span style="color:#f92672">(</span>default <span style="color:#e6db74">&#34;0.0.0.0:8081&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -proxy string
</span></span><span style="display:flex;"><span>    	next hop proxy <span style="color:#66d9ef">for</span> Go Modules, recommend use https://gopropxy.io
</span></span></code></pre></div><ul>
<li>-cacheDir   go module缓存目录，默认$GOPATH/pkg/mod/cache/download</li>
<li>-cacheExpire go module缓存时长(分钟)， 默认5分钟</li>
<li>-exclude 排除指定host模式，你可以排除内部git server host</li>
<li>-listen 监听host和端口， 默认0.0.0.0:8081</li>
<li>-proxy  go module上游代理, 推荐使用 <a href="https://gopropxy.io">https://gopropxy.io</a></li>
</ul>
<h4 id="启动goproxy服务">启动goproxy服务</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">## 新建cache dir</span>
</span></span><span style="display:flex;"><span>root@primary:~# mkdir /usr/local/goproxy/cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 使用nohup命令，在后台启动goproxy进程</span>
</span></span><span style="display:flex;"><span>root@primary:~# nohup goproxy -cacheDir<span style="color:#f92672">=</span>/usr/local/goproxy/cache -exclude<span style="color:#f92672">=</span>gitea.example.com -listen<span style="color:#f92672">=</span>0.0.0.0:80 -proxy<span style="color:#f92672">=</span>https://goproxy.cn &gt; /tmp/goproxy.log 2&gt;&amp;<span style="color:#ae81ff">1</span> &amp;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#ae81ff">23261</span>
</span></span><span style="display:flex;"><span>root@primary:~# ps aux | grep gop
</span></span><span style="display:flex;"><span>root@primary:/usr/local/goproxy# ps aux | grep gop
</span></span><span style="display:flex;"><span>root        <span style="color:#ae81ff">3441</span>  0.0  0.7 <span style="color:#ae81ff">1154944</span> <span style="color:#ae81ff">7376</span> pts/0    Sl   19:24   0:00 goproxy -cacheDir<span style="color:#f92672">=</span>/usr/local/goproxy/cache -exclude<span style="color:#f92672">=</span>gitea.example.com -listen<span style="color:#f92672">=</span>0.0.0.0:80 -proxy<span style="color:#f92672">=</span>https://goproxy.cn
</span></span><span style="display:flex;"><span>root        <span style="color:#ae81ff">3449</span>  0.0  0.2   <span style="color:#ae81ff">7004</span>  <span style="color:#ae81ff">2064</span> pts/0    S+   19:25   0:00 grep --color<span style="color:#f92672">=</span>auto gop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看goproxy服务机器IP地址 如果已经将域名解析到goproxy服务机器，可以直接使用域名。</span>
</span></span><span style="display:flex;"><span>root@primary:~# ip addr
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>    inet6 ::1/128 scope host
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>2: enp0s2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc fq_codel state UP group default qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    link/ether ca:3b:cc:0e:10:69 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    inet 192.168.64.3/24 metric <span style="color:#ae81ff">100</span> brd 192.168.64.255 scope global dynamic enp0s2
</span></span><span style="display:flex;"><span>       valid_lft 74713sec preferred_lft 74713sec
</span></span><span style="display:flex;"><span>    inet6 fd4a:5ec3:8409:4846:c83b:ccff:fe0e:1069/64 scope global dynamic mngtmpaddr noprefixroute
</span></span><span style="display:flex;"><span>       valid_lft 2591984sec preferred_lft 604784sec
</span></span><span style="display:flex;"><span>    inet6 fe80::c83b:ccff:fe0e:1069/64 scope link
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 到这里我们基本的内网goproxy服务就启动了，goproxy服务的地址为:http://192.168.64.3</span>
</span></span></code></pre></div><h4 id="研发机配置goproxy">研发机配置goproxy</h4>
<p>在开发机器上配置<!-- raw HTML omitted -->GOPROXY<!-- raw HTML omitted -->。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">## 研发机器继续使用ubuntu</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看go环境变量</span>
</span></span><span style="display:flex;"><span>root@huge-elk:~# go env
</span></span><span style="display:flex;"><span>GO111MODULE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GOARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;amd64&#34;</span>
</span></span><span style="display:flex;"><span>GOBIN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GOCACHE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/.cache/go-build&#34;</span>
</span></span><span style="display:flex;"><span>GOENV<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/.config/go/env&#34;</span>
</span></span><span style="display:flex;"><span>GOEXE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GOEXPERIMENT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GOFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GOHOSTARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;amd64&#34;</span>
</span></span><span style="display:flex;"><span>GOHOSTOS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>GOINSECURE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GOMODCACHE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/go/pkg/mod&#34;</span>
</span></span><span style="display:flex;"><span>GONOPROXY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GONOSUMDB<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GOOS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>GOPATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/go&#34;</span>
</span></span><span style="display:flex;"><span>GOPRIVATE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GOPROXY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://proxy.golang.org,direct&#34;</span>
</span></span><span style="display:flex;"><span>GOROOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/usr/lib/go-1.18&#34;</span>
</span></span><span style="display:flex;"><span>GOSUMDB<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sum.golang.org&#34;</span>
</span></span><span style="display:flex;"><span>GOTMPDIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GOTOOLDIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/usr/lib/go-1.18/pkg/tool/linux_amd64&#34;</span>
</span></span><span style="display:flex;"><span>GOVCS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>GOVERSION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;go1.18.1&#34;</span>
</span></span><span style="display:flex;"><span>GCCGO<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gccgo&#34;</span>
</span></span><span style="display:flex;"><span>GOAMD64<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;v1&#34;</span>
</span></span><span style="display:flex;"><span>AR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ar&#34;</span>
</span></span><span style="display:flex;"><span>CC<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gcc&#34;</span>
</span></span><span style="display:flex;"><span>CXX<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;g++&#34;</span>
</span></span><span style="display:flex;"><span>CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>GOMOD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/dev/null&#34;</span>
</span></span><span style="display:flex;"><span>GOWORK<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>CGO_CFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-g -O2&#34;</span>
</span></span><span style="display:flex;"><span>CGO_CPPFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>CGO_CXXFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-g -O2&#34;</span>
</span></span><span style="display:flex;"><span>CGO_FFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-g -O2&#34;</span>
</span></span><span style="display:flex;"><span>CGO_LDFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-g -O2&#34;</span>
</span></span><span style="display:flex;"><span>PKG_CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pkg-config&#34;</span>
</span></span><span style="display:flex;"><span>GOGCCFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build2599397427=/tmp/go-build -gno-record-gcc-switches&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 设置GO111MODULE=on, 使用mod模式开发</span>
</span></span><span style="display:flex;"><span>root@huge-elk:~# go env -w GO111MODULE<span style="color:#f92672">=</span>on
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 将GOPROXY设置为我们配置的内网host</span>
</span></span><span style="display:flex;"><span>root@huge-elk:~# go env -w GOPROXY<span style="color:#f92672">=</span>http://192.168.64.3,direct
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看修改是否生效</span>
</span></span><span style="display:flex;"><span>root@huge-elk:~# go env GO111MODULE GOPROXY
</span></span><span style="display:flex;"><span>on
</span></span><span style="display:flex;"><span>http://192.168.64.3,direct
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 拉取公网go模块 </span>
</span></span><span style="display:flex;"><span>root@huge-elk:~# go install github.com/fbbyqsyea/wechat@latest
</span></span><span style="display:flex;"><span>go: downloading github.com/fbbyqsyea/wechat v0.0.4
</span></span><span style="display:flex;"><span>package github.com/fbbyqsyea/wechat is not a main package
</span></span></code></pre></div><h4 id="拉取内网gitea-go模块">拉取内网gitea go模块</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">## 要拉取gitea代码，goproxy机器必须配置对应仓库的访问权限</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 生成SSH密钥</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 1. 进入 ~/.ssh目录</span>
</span></span><span style="display:flex;"><span>root@primary:~# cd ~/.ssh
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 2. 使用ssh-keygen命令生成rsa公私钥 id_rsa_git为秘钥名称，不要设置密码，直接按几次回车键，完成密钥创建</span>
</span></span><span style="display:flex;"><span>root@primary:~/.ssh# ssh-keygen -t rsa
</span></span><span style="display:flex;"><span>Generating public/private rsa key pair.
</span></span><span style="display:flex;"><span>Enter file in which to save the key <span style="color:#f92672">(</span>/root/.ssh/id_rsa<span style="color:#f92672">)</span>: id_rsa_git
</span></span><span style="display:flex;"><span>Enter passphrase <span style="color:#f92672">(</span>empty <span style="color:#66d9ef">for</span> no passphrase<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>Enter same passphrase again:
</span></span><span style="display:flex;"><span>Your identification has been saved in id_rsa_git
</span></span><span style="display:flex;"><span>Your public key has been saved in id_rsa_git.pub
</span></span><span style="display:flex;"><span>The key fingerprint is:
</span></span><span style="display:flex;"><span>SHA256:URSu2NTjQomvYIyRF3U+A0XCkHT7V7AHz/1RazPCil0 root@primary
</span></span><span style="display:flex;"><span>The key<span style="color:#960050;background-color:#1e0010">&#39;</span>s randomart image is:
</span></span><span style="display:flex;"><span>+---<span style="color:#f92672">[</span>RSA 3072<span style="color:#f92672">]</span>----+
</span></span><span style="display:flex;"><span>|   .+<span style="color:#f92672">==</span>o+.*.    .|
</span></span><span style="display:flex;"><span>|   ..o.B <span style="color:#f92672">=</span> *..  o|
</span></span><span style="display:flex;"><span>|  o . o O <span style="color:#f92672">=</span> <span style="color:#f92672">=</span>E.* |
</span></span><span style="display:flex;"><span>|   <span style="color:#f92672">=</span>   B *o+o o.+|
</span></span><span style="display:flex;"><span>|  . + . S.oo    .|
</span></span><span style="display:flex;"><span>|   . . . o       |
</span></span><span style="display:flex;"><span>|      .          |
</span></span><span style="display:flex;"><span>|                 |
</span></span><span style="display:flex;"><span>|                 |
</span></span><span style="display:flex;"><span>+----<span style="color:#f92672">[</span>SHA256<span style="color:#f92672">]</span>-----+
</span></span><span style="display:flex;"><span>root@primary:~/.ssh# ll
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>drwx------ <span style="color:#ae81ff">2</span> root root <span style="color:#ae81ff">4096</span> Oct <span style="color:#ae81ff">31</span> 19:39 ./
</span></span><span style="display:flex;"><span>drwx------ <span style="color:#ae81ff">8</span> root root <span style="color:#ae81ff">4096</span> Oct <span style="color:#ae81ff">31</span> 19:37 ../
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">562</span> Oct <span style="color:#ae81ff">31</span> 19:08 authorized_keys
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">2602</span> Oct <span style="color:#ae81ff">31</span> 19:39 id_rsa_git
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">566</span> Oct <span style="color:#ae81ff">31</span> 19:39 id_rsa_git.pub
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 配置gitea公钥</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 1.获取公钥内容</span>
</span></span><span style="display:flex;"><span>root@primary:~/.ssh# cat id_rsa_git.pub
</span></span><span style="display:flex;"><span>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCi+BCfnmWmI+6LsIfB42op5Y5a7MuxPw3PQb4uy5p/OEjDTN+XfCg763V7/0ZR0jL1Brer6zgOczm5FaVbIgbdwc7KXBE4fhqDJMdlDmWWaP71jaVbzdQnLkGE88xXqKG0gZT+n+JwJbC+ZymAkwZsOJvWa0TWIcL9MVgspyN19R8ZuvUJ6iws+rhx//6EPDa3FPkkzAD7LLkDRqb6rd+Ml8jhmN21x2aPU6R6WIXJbHqN3r5Rs9d58oHS/60e+Z2uYiHYr9oxs4Vun6YZCY2x1c5rfJOlHlOtZI9T5n2GScRykVBbNCp4OEv69Ga8xN6q2k6oQKYylF7+7J99S9nOUvX95E0sVGcNAHBupAZ4xst/y/XL8QQxNwn1+cEwuOHJp0er8qHp83kPqAn/8pQwzT+6UTfKfcj+eP9w742an9eIwtcjD1FBYvKqUkh0739vvshFBJOHSF/LQMRo8ARU8AfAxfhkTqc4O98xADwDTxKCZ3HHZNkK7SB/1XMiXiU<span style="color:#f92672">=</span> root@primary
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 2.使用有权限的账号登录gitea并且配置公钥，配置路径:Gitea “用户设置 -&gt; SSH/GPG秘钥 -&gt; 管理 SSH 密钥 -&gt;增加秘钥</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 配置本地私钥</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 1.打开~/.ssh/config，添加如下内容</span>
</span></span><span style="display:flex;"><span>root@primary:~# vim ~/.ssh/config
</span></span><span style="display:flex;"><span>root@primary:~# cat ~/.ssh/config
</span></span><span style="display:flex;"><span> Host *
</span></span><span style="display:flex;"><span> HostkeyAlgorithms +ssh-rsa
</span></span><span style="display:flex;"><span> PubkeyAcceptedKeyTypes +ssh-rsa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Host gitea.example.com
</span></span><span style="display:flex;"><span> HostName gitea.example.com
</span></span><span style="display:flex;"><span> Port <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span> User git
</span></span><span style="display:flex;"><span> IdentityFile ~/.ssh/id_rsa_git
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 2. 给config文件可执行权限</span>
</span></span><span style="display:flex;"><span>root@primary:~# chmod a+x ~/.ssh/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 修改git clone方式</span>
</span></span><span style="display:flex;"><span>root@primary:~/.ssh# git config --global url.<span style="color:#e6db74">&#34;ssh://git@gitea.example.com&#34;</span>.insteadOf <span style="color:#e6db74">&#34;https://gitea.example.com&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 由于gitea https证书已过期，所以设置GOINSECURE变量，忽略gitea.example.com https校验</span>
</span></span><span style="display:flex;"><span>root@primary:~/.ssh# go env -w GOINSECURE<span style="color:#f92672">=</span>gitea.example.com
</span></span><span style="display:flex;"><span>root@primary:~/.ssh# go env GOINSECURE
</span></span><span style="display:flex;"><span>gitea.example.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 测试安装内网gitea项目 (研发机器)</span>
</span></span><span style="display:flex;"><span>root@huge-elk:~# go install gitea.example.com/goweb/gin-framework-layout@latest
</span></span><span style="display:flex;"><span>go: downloading gitea.example.com/goweb/gin-framework-layout v0.0.0-20221028094355-547f7a489c3b
</span></span><span style="display:flex;"><span>go: gitea.example.com/goweb/gin-framework-layout@latest: gitea.example.com/goweb/gin-framework-layout@v0.0.0-20221028094355-547f7a489c3b: verifying module: gitea.example.com/goweb/gin-framework-layout@v0.0.0-20221028094355-547f7a489c3b: reading http://192.168.64.3/sumdb/sum.golang.org/lookup/gitea.example.com/goweb/gin-framework-layout@v0.0.0-20221028094355-547f7a489c3b: <span style="color:#ae81ff">404</span> Not Found
</span></span><span style="display:flex;"><span>	server response: not found: gitea.example.com/goweb/gin-framework-layout@v0.0.0-20221028094355-547f7a489c3b: unrecognized import path <span style="color:#e6db74">&#34;gitea.example.com/goweb/gin-framework-layout&#34;</span>: https fetch: Get <span style="color:#e6db74">&#34;https://gitea.example.com/goweb/gin-framework-layout?go-get=1&#34;</span>: dial tcp: lookup gitea.example.com on 8.8.8.8:53: no such host
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 目前gin-framework-layout模块安装成功，但是sum校验失败，设置内部项目忽略校验 (研发机器)</span>
</span></span><span style="display:flex;"><span>root@huge-elk:~# go env -w GONOSUMDB<span style="color:#f92672">=</span>gitea.example.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 重新安装</span>
</span></span><span style="display:flex;"><span>root@huge-elk:~# go clean -modcache
</span></span><span style="display:flex;"><span>root@huge-elk:~# go env -w GONOSUMDB<span style="color:#f92672">=</span>gitea.example.com
</span></span><span style="display:flex;"><span>root@huge-elk:~# go install gitea.example.com/goweb/gin-framework-layout@latest
</span></span><span style="display:flex;"><span>go: downloading gitea.example.com/goweb/gin-framework-layout v0.0.0-20221028094355-547f7a489c3b
</span></span><span style="display:flex;"><span>go: downloading gitea.example.com/goweb/gin-framework-core v0.0.1
</span></span><span style="display:flex;"><span>go: downloading github.com/gin-gonic/gin v1.8.1
</span></span><span style="display:flex;"><span>go: downloading github.com/go-redis/redis v6.15.9+incompatible
</span></span><span style="display:flex;"><span>go: downloading github.com/go-sql-driver/mysql v1.6.0
</span></span><span style="display:flex;"><span>go: downloading github.com/jmoiron/sqlx v1.3.5
</span></span><span style="display:flex;"><span>go: downloading github.com/spf13/viper v1.13.0
</span></span><span style="display:flex;"><span>go: downloading go.uber.org/zap v1.23.0
</span></span><span style="display:flex;"><span>go: downloading gopkg.in/natefinch/lumberjack.v2 v2.0.0
</span></span><span style="display:flex;"><span>go: downloading github.com/Masterminds/squirrel v1.5.3
</span></span><span style="display:flex;"><span>go: downloading github.com/mcuadros/go-defaults v1.2.0
</span></span><span style="display:flex;"><span>go: downloading github.com/gin-contrib/sse v0.1.0
</span></span><span style="display:flex;"><span>go: downloading github.com/mattn/go-isatty v0.0.14
</span></span><span style="display:flex;"><span>go: downloading golang.org/x/net v0.1.0
</span></span><span style="display:flex;"><span>go: downloading github.com/fsnotify/fsnotify v1.5.4
</span></span><span style="display:flex;"><span>go: downloading github.com/mitchellh/mapstructure v1.5.0
</span></span><span style="display:flex;"><span>go: downloading github.com/spf13/afero v1.8.2
</span></span><span style="display:flex;"><span>go: downloading github.com/spf13/cast v1.5.0
</span></span><span style="display:flex;"><span>go: downloading github.com/spf13/jwalterweatherman v1.1.0
</span></span><span style="display:flex;"><span>go: downloading github.com/spf13/pflag v1.0.5
</span></span><span style="display:flex;"><span>go: downloading go.uber.org/atomic v1.7.0
</span></span><span style="display:flex;"><span>go: downloading go.uber.org/multierr v1.6.0
</span></span><span style="display:flex;"><span>go: downloading gitea.example.com/goweb/go-utils v0.0.0-20221028065316-8abebfd58706
</span></span><span style="display:flex;"><span>go: downloading github.com/dgrijalva/jwt-go v3.2.0+incompatible
</span></span><span style="display:flex;"><span>go: downloading github.com/lann/builder v0.0.0-20180802200727-47ae307949d0
</span></span><span style="display:flex;"><span>go: downloading github.com/go-playground/validator/v10 v10.10.0
</span></span><span style="display:flex;"><span>go: downloading github.com/pelletier/go-toml/v2 v2.0.5
</span></span><span style="display:flex;"><span>go: downloading github.com/pelletier/go-toml v1.9.5
</span></span><span style="display:flex;"><span>go: downloading github.com/ugorji/go/codec v1.2.7
</span></span><span style="display:flex;"><span>go: downloading google.golang.org/protobuf v1.28.0
</span></span><span style="display:flex;"><span>go: downloading gopkg.in/yaml.v2 v2.4.0
</span></span><span style="display:flex;"><span>go: downloading golang.org/x/sys v0.1.0
</span></span><span style="display:flex;"><span>go: downloading golang.org/x/text v0.4.0
</span></span><span style="display:flex;"><span>go: downloading github.com/subosito/gotenv v1.4.1
</span></span><span style="display:flex;"><span>go: downloading github.com/hashicorp/hcl v1.0.0
</span></span><span style="display:flex;"><span>go: downloading gopkg.in/ini.v1 v1.67.0
</span></span><span style="display:flex;"><span>go: downloading github.com/magiconair/properties v1.8.6
</span></span><span style="display:flex;"><span>go: downloading gopkg.in/yaml.v3 v3.0.1
</span></span><span style="display:flex;"><span>go: downloading github.com/lann/ps v0.0.0-20150810152359-62de8c46ede0
</span></span><span style="display:flex;"><span>go: downloading github.com/go-playground/universal-translator v0.18.0
</span></span><span style="display:flex;"><span>go: downloading github.com/leodido/go-urn v1.2.1
</span></span><span style="display:flex;"><span>go: downloading golang.org/x/crypto v0.0.0-20220411220226-7b82a4e95df4
</span></span><span style="display:flex;"><span>go: downloading github.com/go-playground/locales v0.14.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gitea.example.com/goweb/gin-framework-layout</span>
</span></span><span style="display:flex;"><span>go/pkg/mod/gitea.example.com/goweb/gin-framework-layout@v0.0.0-20221028094355-547f7a489c3b/main.go:9:7: undefined: core.New
</span></span><span style="display:flex;"><span>note: module requires Go 1.19
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>到这里我们内网goproxy服务搭建配置成功
</span></span></code></pre></div>
</div>


    </main>

    
      
    
  </body>
</html>
