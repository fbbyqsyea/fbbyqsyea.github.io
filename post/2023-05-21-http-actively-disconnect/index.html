<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.117.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>http断开后，如何继续执行服务端代码 &middot; bing随遇而安</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://fbbmore.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  
  
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

  
  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://fbbmore.com/"><h1>bing随遇而安</h1></a>
      <p class="lead">
       废柴都是间歇性的自虐 强者却是持续性的自律 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://fbbmore.com/">首页</a> </li>
        <li><a href="https://fbbmore.com//tags">标签</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>http断开后，如何继续执行服务端代码</h1>
  <time datetime=2023-05-21T11:39:53Z class="post-date">Sun, May 21, 2023</time>
  <h2 id="问题">问题</h2>
<h4 id="业务需求">业务需求</h4>
<ul>
<li>服务端需要调用一个event stream格式响应的接口，实时响应数据给客户端。</li>
<li>响应数据是被分为多个数据块，以流失数据的形式给到。</li>
<li>服务端能够实现对event stream接口的完整调用</li>
</ul>
<h4 id="遇到问题">遇到问题</h4>
<p>由于公司主流的技术架构还是lamp那一套，apache服务器通过调用php module来执行php的脚本。当http请求断开后，php脚本就会终止执行。当客户端没有等待http响应完成就主动断开了连接，就会导致服务端没有从封装的event stream接口中获取到完整的数据。是一次无效的接口调用。</p>
<h2 id="思考">思考</h2>
<p>为了解决上面的问题，基于公司现有的技术架构，我首先想到了如下方案:</p>
<h4 id="方案10">方案1.0</h4>
<ul>
<li>开启多个常驻的php进程来处理event stream接口的调用，生产数据。</li>
<li>使用redis list来进行数据之间的同步。</li>
<li>服务端通告轮询redis list消费数据，直到接受到&quot;data [done]&ldquo;结束。</li>
</ul>
<h6 id="优缺点">优缺点</h6>
<ul>
<li>优点是http断开后常驻脚本依旧能够完成接口的调用。</li>
<li>缺点是无法解决多用户的并发问题，同一个常驻脚本同一时间只能处理一个请求。</li>
</ul>
<p>在考虑到并发之后，我想到了下面的第二个方案:</p>
<h4 id="方案20">方案2.0</h4>
<ul>
<li>使用go来实现业务逻辑，并以api或者让rpc的形式暴露服务，供php调用。这样既能解决调用event stream接口调用完整性的问题，同时还能实现高并发的能力。而且go有着比php更高的性能。</li>
</ul>
<h2 id="解答">解答</h2>
<p>下面的解答示例只演示了http主动断开后go继续执行直到结束的相关demo</p>
<h4 id="demo">DEMO</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Default</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Any</span>(<span style="color:#e6db74">&#34;/long_async_operation&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 启动goroutine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 进行耗时操作
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 结束时打印日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;long_async_operation done&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;:8081&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="启动服务">启动服务</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go run main.go
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span> Creating an Engine instance with the Logger and Recovery middleware already attached.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span> Running in <span style="color:#e6db74">&#34;debug&#34;</span> mode. Switch to <span style="color:#e6db74">&#34;release&#34;</span> mode in production.
</span></span><span style="display:flex;"><span> - using env:   export GIN_MODE<span style="color:#f92672">=</span>release
</span></span><span style="display:flex;"><span> - using code:  gin.SetMode<span style="color:#f92672">(</span>gin.ReleaseMode<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> GET    /long_async_operation     --&gt; main.main.func1 <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> handlers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> POST   /long_async_operation     --&gt; main.main.func1 <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> handlers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> PUT    /long_async_operation     --&gt; main.main.func1 <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> handlers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> PATCH  /long_async_operation     --&gt; main.main.func1 <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> handlers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> HEAD   /long_async_operation     --&gt; main.main.func1 <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> handlers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> OPTIONS /long_async_operation     --&gt; main.main.func1 <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> handlers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> DELETE /long_async_operation     --&gt; main.main.func1 <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> handlers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> CONNECT /long_async_operation     --&gt; main.main.func1 <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> handlers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> TRACE  /long_async_operation     --&gt; main.main.func1 <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> handlers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span> You trusted all proxies, this is NOT safe. We recommend you to set a value.
</span></span><span style="display:flex;"><span>Please check https://pkg.go.dev/github.com/gin-gonic/gin#readme-don-t-trust-all-proxies <span style="color:#66d9ef">for</span> details.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN-debug<span style="color:#f92672">]</span> Listening and serving HTTP on :8081
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>GIN<span style="color:#f92672">]</span> 2023/05/21 - 12:17:34 | <span style="color:#ae81ff">200</span> |         750ns |       127.0.0.1 | HEAD     <span style="color:#e6db74">&#34;/long_async_operation&#34;</span>
</span></span><span style="display:flex;"><span>2023/05/21 12:17:35 long_async_operation <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>2023/05/21 12:17:36 long_async_operation <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>2023/05/21 12:17:37 long_async_operation <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>2023/05/21 12:17:38 long_async_operation <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>2023/05/21 12:17:39 long_async_operation <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>2023/05/21 12:17:40 long_async_operation <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>2023/05/21 12:17:41 long_async_operation <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>2023/05/21 12:17:42 long_async_operation <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>2023/05/21 12:17:43 long_async_operation <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>2023/05/21 12:17:44 long_async_operation <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><h4 id="客户端调用">客户端调用</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -I http://localhost:8081/long_async_operation
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#ae81ff">200</span> OK
</span></span><span style="display:flex;"><span>Date: Sun, <span style="color:#ae81ff">21</span> May <span style="color:#ae81ff">2023</span> 04:17:34 GMT
</span></span></code></pre></div>
</div>


    </main>

    
      
    
  </body>
</html>
